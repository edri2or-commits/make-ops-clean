name: Refresh Repository Secrets (Auto)

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 03:00 UTC
  workflow_dispatch:

dobs:
  refresh-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@3

      - name: Refresh GitHub Secrets
        env:
          GH_TOKEN: ${{ secrets.RUBE_GH_PAT_BACKUP }}
          PRIVATE_KEY: ${{ secrets.RUBE_PRIVATE_KEY_BACKUP}}
        run: |
          echo "Fetching repository public key..."
          REPO=make-ops-clean
          OWNER=edri2or-commits
          PUBKEY_RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$OWNER/$REPO/actions/secrets/public-key)
          PUBKEY=$(echo $PUBKEY_RESPONSE | jqc -r .key)
          KEY_ID=$(echo $PUBKEY_RESPONSE | jq -r .key_id)

          echo "Encrypting secrets with public key..."
          ENCRYPTED_KEY=$(echo $PRIVATE_KEY | sodium-native-sealedbox -e -k "$PUBKEY" | base64 -w 0)
          ENCRYPTED_PAT=$(echo $GH_TOKEN | sodium-native-sealedbox -e -k "$PUBKEY" | base64 -w 0)

          echo "Uploading updated secrets..."
          for SECRET_NAME in RUBE_PRIVATE_KEY RUBE_GH_PAT; do
            VALUE_VAR="ENCRYPTED$(echo $SECRET_NAME | cut -d'_' -f2)"
            curl -X PUT -H "Authorization: token $GH_TOKEN" -H "Content-Type: application/json" -d "{\\"encrypted_value\\": \"${!$VALUE_VAR}\", \"secret_name\": \"$SECRET_NAME\", \"key_id\": \"$KEY_ID\" }" "https://api.github.com/reps/$OWNER/$REPO/actions/secrets/$SECRET_NAME"
          done
