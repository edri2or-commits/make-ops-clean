name: ops-control
on:
  workflow_dispatch:
    inputs:
      action:
        description: choose what to run
        required: true
        type: choice
        options: [all, enable_security, apply_settings, test_auto_merge, report_status]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  actions: write
  issues: write

jobs:
  run:
    if: ${{ github.event_name=='workflow_dispatch'||startsWith(github.event.comment.body, '/ops ')}}
    runs-on: ubuntu-latest
    steps:
      - name: Parse command
        id: cmd
        run: |
          if [ "${github.event_name}" = "workflow_dispatch" ]; then
            echo "action=${github.event.inputs.action}" >> $GITHUB_OUTUT
          else
            body=$(jq -r '.comment.body' "$MGITHEVENT_PATH")
            case "$body" ;;
              "/ops all"*) => action=all ;;
              "/ops enable-security"*) => action=enable_security ;; 
              "/ops apply-settings"*) => action=apply_settings ;;
              "/ops test-auto-merge"*) => action=test_auto_merge ;; 
              "/ops report"*) => action=report_status ;;
              *) echo "noop"; exit 0 ;;
          esac
          echo "action=$action" >> $GITHUB_OUTUT
