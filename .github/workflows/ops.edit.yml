name: ops.edit (PR-only via GitHub App)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [ops.edit]

permissions:
  contents: read
  pull-requests: read

jobs:
  pr_only:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PRIVATE_KEY format (no output of secrets)
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          set -euo pipefail
          printf '%s' "$PRIVATE_KEY" > key.pem
          # יאפס ב־non-zero אם המפתח לא PEM תקין; לא מדפיס את המפתח
          openssl pkey -in key.pem -noout >/dev/null

      - uses: actions/create-github-app-token@v2
        id: app
        with:
          app-id: ${{ secrets.APP_ID }}           # או המספר 2145601
          private-key: ${{ secrets.PRIVATE_KEY }} # PEM כפי שהורד מגיטהאב

      - name: Create branch & file and open PR (curl only)
        env:
          GH_TOKEN: ${{ steps.app.outputs.token }}
          API: https://api.github.com
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          base=$(curl -sL -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
                 "$API/repos/$repo" | python3 -c "import sys,json;print(json.load(sys.stdin)['default_branch'])")
          ts=$(date -u +%Y%m%dT%H%M%SZ); branch="ops/${ts}"
          base_sha=$(curl -sL -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
                    "$API/repos/$repo/git/ref/heads/$base" | python3 -c "import sys,json;print(json.load(sys.stdin)['object']['sha'])")
          curl -sL -X POST -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
               "$API/repos/$repo/git/refs" -d "{\"ref\":\"refs/heads/${branch}\",\"sha\":\"${base_sha}\"}" \
               || echo "note: branch may exist already"
          path=".chatops/runs/${ts}.txt"
          content=$(printf "PR proof via App Installation at %s\n" "$ts" | base64 -w0)
          curl -sL -X PUT -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
               "$API/repos/$repo/contents/${path}" \
               -d "{\"message\":\"chore(chatops): e2e proof (no-merge)\",\"content\":\"${content}\",\"branch\":\"${branch}\"}"
          pr_json=$(curl -sL -X POST -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
                   "$API/repos/$repo/pulls" \
                   -d "{\"title\":\"chatops: e2e proof (no-merge)\",\"head\":\"${branch}\",\"base\":\"${base}\"}")
          pr_url=$(python3 - <<'PY'
import sys, json
print(json.load(sys.stdin)['html_url'])
PY
          <<< "$pr_json")
          echo "PR: ${pr_url}"
