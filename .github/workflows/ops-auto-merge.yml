name: ops-auto-merge
on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main ]
permissions:
  pull-requests: write
  contents: write
jobs:
  auto-approve-and-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Guard prefixes
        id: guard
        run: |
          set -euo pipefail
          HEAD_REF=$(jq -r '.pull_request.head.ref' "$GITHUB_EVENT_PATH")
          case "$HEAD_REF" in
            ops/*|ci/*|feat/*) echo "ok" ;;
            *) echo "not an ops/ci/feat branch; exiting"; exit 0 ;;
          esac
      - name: Approve PR
        if: ${{ steps.guard.outcome == 'success' }}
        run: |
          PR=$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")
          gh pr review "$PR" --approve
      - name: Squash merge and delete branch
        if: ${{ steps.guard.outcome == 'success' }}
        run: |
          PR=$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")
          gh pr merge "$PR" --squash --delete-branch --admin \
            --subject "ops: auto-merge PR #$PR" --body "Automated operational merge"
