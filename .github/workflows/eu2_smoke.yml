name: EU2 Smoke (API-First)

on:
  workflow_dispatch: {}

permissions:
  contents: read

env:
  EU_BASE: https://eu2.make.com/api/v2
  ENDPOINT: /scenarios?organizationId=5226765&limit=1
  EXPECTED: "200"

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Preflight â€” token length (no print)
        shell: bash
        run: |
          set -euo pipefail
          tok="${{ secrets.MAKE_API_TOKEN }}"
          if [ -z "$tok" ]; then
            echo "No MAKE_API_TOKEN"; exit 1
          fi
          len=$(printf '%s' "$tok" | wc -c | tr -d ' ')
          echo "RUN=NC-2 | STEP=preflight | RESULT=pass | METRICS=token_len:$len" >> "$GITHUB_STEP_SUMMARY"

      - name: Prove runner egress IP (not client device)
        shell: bash
        run: |
          set -euo pipefail
          curl -s https://ifconfig.me > ip.txt
          echo "RUN=NC-2 | STEP=egress_ip | RESULT=$(cat ip.txt)" >> "$GITHUB_STEP_SUMMARY"

      - name: Smoke GET EU2
        id: get
        shell: bash
        run: |
          set -euo pipefail
          : "${GITHUB_STEP_SUMMARY:=/dev/null}"
          : "${GITHUB_OUTPUT:=/tmp/gh_out}"
          EU_BASE="${EU_BASE:-https://eu2.make.com/api/v2}"
          ENDPOINT="${ENDPOINT:-/scenarios?organizationId=5226765&limit=1}"
          EXPECTED="${EXPECTED:-200}"
          URL="${EU_BASE}${ENDPOINT}"

          code=$(curl -sS -D headers.txt -o body.json -w "%{http_code}" \
            -H "Accept: application/json" \
            -H "Authorization: Token ${{ secrets.MAKE_API_TOKEN }}" "$URL" || true)

          echo "code=$code" >> "$GITHUB_OUTPUT" || true

          {
            echo "RUN=NC-2 | STEP=http_get | RESULT=$code"
            echo "URL=$URL"
            echo "Expected=$EXPECTED"
            grep -i '^Date:' headers.txt  || true
            grep -i '^X-Request-Id:' headers.txt || true
            grep -i '^WWW-Authenticate:' headers.txt || true
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Assert expected status
        shell: bash
        run: |
          [ "${{ steps.get.outputs.code }}" = "$EXPECTED" ] || {
            echo "Unexpected: ${{ steps.get.outputs.code }}"; exit 1;
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: eu2-smoke-artifacts
          path: |
            headers.txt
            body.json
            ip.txt