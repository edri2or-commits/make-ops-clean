name: EU2 Smoke (API-First)

on:
  workflow_dispatch: {}

permissions:
  contents: read

# קונפיג לא-סודי מתוך Variables
env:
  API_BASE: https://${{ vars.MAKE_BASE }}.make.com/api/v2
  ORG_ID: ${{ vars.MAKE_ORG_ID }}      # אופציונלי; אם ריק ניסע בלי organizationId
  EXPECTED: "200"

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Preflight — token present (no print)
        shell: bash
        run: |
          set -euo pipefail
          tok="${{ secrets.MAKE_API_TOKEN }}"
          if [ -z "${tok}" ]; then
            echo "No MAKE_API_TOKEN"; exit 1
          fi
          len=$(printf '%s' "$tok" | wc -c | tr -d ' ')
          echo "RUN=EU2_SMOKE | STEP=preflight | RESULT=pass | token_len=${len}" >> "$GITHUB_STEP_SUMMARY"

      - name: Runner egress IP
        shell: bash
        run: |
          set -euo pipefail
          curl -sS https://ifconfig.me > ip.txt
          echo "RUN=EU2_SMOKE | STEP=egress_ip | ip=$(cat ip.txt)" >> "$GITHUB_STEP_SUMMARY"

      - name: Smoke GET /scenarios
        id: get
        shell: bash
        env:
          API_BASE: ${{ env.API_BASE }}
          ORG_ID: ${{ env.ORG_ID }}
          EXPECTED: ${{ env.EXPECTED }}
        run: |
          set -euo pipefail
          : "${GITHUB_STEP_SUMMARY:=/dev/null}"
          : "${GITHUB_OUTPUT:=/tmp/gh_out}"

          QS="limit=1"
          if [ -n "${ORG_ID:-}" ]; then QS="organizationId=${ORG_ID}&${QS}"; fi
          URL="${API_BASE}/scenarios?${QS}"

          code=$(curl -sS -D headers.txt -o body.json -w "%{http_code}" \
            -H "Accept: application/json" \
            -H "Authorization: Token ${{ secrets.MAKE_API_TOKEN }}" \
            "$URL" || true)

          echo "code=${code}" >> "$GITHUB_OUTPUT" || true

          {
            echo "RUN=EU2_SMOKE | STEP=http_get | RESULT=${code}"
            echo "URL=${URL}"
            echo "Expected=${EXPECTED}"
            grep -i '^Date:' headers.txt  || true
            grep -i '^X-Request-Id:' headers.txt || true
            grep -i '^WWW-Authenticate:' headers.txt || true
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Assert expected status
        shell: bash
        run: |
          [ "${{ steps.get.outputs.code }}" = "${{ env.EXPECTED }}" ] || {
            echo "Unexpected: ${{ steps.get.outputs.code }}"; exit 1;
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: eu2-smoke-artifacts
          path: |
            headers.txt
            body.json
            ip.txt
