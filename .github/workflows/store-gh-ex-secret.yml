name: Store GH_EX Secret

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "מאשר כתיבה" to confirm secret storage'
        required: true
        type: string

jobs:
  store-secret:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'מאשר כתיבה'
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/212701048029/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions@edri2or-mcp.iam.gserviceaccount.com'
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Verify PAT secret exists in repo
        run: |
          if [ -z "${{ secrets.GITHUB_EXECUTOR_PAT }}" ]; then
            echo "❌ ERROR: GITHUB_EXECUTOR_PAT not found in repository secrets"
            echo "Please add it at: Settings → Secrets and variables → Actions"
            exit 1
          fi
          echo "✅ GITHUB_EXECUTOR_PAT found in repo secrets"
      
      - name: Check if GH_EX already exists
        id: check-exists
        run: |
          if gcloud secrets describe GH_EX --project=edri2or-mcp 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "⚠️  GH_EX already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "✅ GH_EX does not exist (will create)"
          fi
      
      - name: Create GH_EX secret
        if: steps.check-exists.outputs.exists == 'false'
        env:
          GH_PAT: ${{ secrets.GITHUB_EXECUTOR_PAT }}
        run: |
          echo "Creating GH_EX secret in Secret Manager..."
          echo "$GH_PAT" | gcloud secrets create GH_EX \
            --project=edri2or-mcp \
            --replication-policy=automatic \
            --data-file=-
          
          echo "✅ GH_EX secret created successfully"
      
      - name: Update GH_EX secret (if exists)
        if: steps.check-exists.outputs.exists == 'true'
        env:
          GH_PAT: ${{ secrets.GITHUB_EXECUTOR_PAT }}
        run: |
          echo "Updating GH_EX secret with new version..."
          echo "$GH_PAT" | gcloud secrets versions add GH_EX \
            --project=edri2or-mcp \
            --data-file=-
          
          echo "✅ GH_EX secret updated with new version"
      
      - name: Grant access to Cloud Run service account
        run: |
          echo "Granting secretAccessor role to github-actions service account..."
          gcloud secrets add-iam-policy-binding GH_EX \
            --project=edri2or-mcp \
            --member="serviceAccount:github-actions@edri2or-mcp.iam.gserviceaccount.com" \
            --role="roles/secretmanager.secretAccessor" \
            --condition=None || echo "IAM binding may already exist"
          
          echo "✅ Service account has access to GH_EX"
      
      - name: Verify secret is accessible
        run: |
          echo "Verifying secret can be accessed..."
          if gcloud secrets versions access latest --secret=GH_EX --project=edri2or-mcp > /dev/null 2>&1; then
            echo "✅ Secret is accessible (value not shown for security)"
          else
            echo "❌ Secret access failed"
            exit 1
          fi
      
      - name: Create evidence file
        run: |
          mkdir -p OPS/EVIDENCE
          cat > OPS/EVIDENCE/gh_ex_secret_stored_$(date +%Y%m%d_%H%M%S).json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "action": "store_gh_ex_secret",
            "project": "edri2or-mcp",
            "secret_name": "GH_EX",
            "status": "success",
            "operation": "${{ steps.check-exists.outputs.exists == 'true' && 'updated' || 'created' }}",
            "iam_binding": "github-actions@edri2or-mcp.iam.gserviceaccount.com",
            "workflow_run": "${{ github.run_id }}",
            "triggered_by": "${{ github.actor }}"
          }
          EOF
      
      - name: Upload evidence
        uses: actions/upload-artifact@v4
        with:
          name: gh-ex-secret-evidence
          path: OPS/EVIDENCE/gh_ex_secret_stored_*.json
      
      - name: Summary
        run: |
          echo "## ✅ GH_EX Secret Storage Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Operation**: ${{ steps.check-exists.outputs.exists == 'true' && 'Updated existing secret' || 'Created new secret' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: edri2or-mcp" >> $GITHUB_STEP_SUMMARY
          echo "**Secret Name**: GH_EX" >> $GITHUB_STEP_SUMMARY
          echo "**Service Account Access**: ✅ Granted" >> $GITHUB_STEP_SUMMARY
          echo "**Verification**: ✅ Secret accessible" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Step**: Deploy GitHub Executor API to Cloud Run" >> $GITHUB_STEP_SUMMARY
