name: token sanity check
on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Make token check (HTTP code only)
        id: make
        env:
          MAKE_API_TOKEN: ${{ secrets.MAKE_API_TOKEN }}
          MAKE_BASE: ${{ env.MAKE_BASE }}
          SCENARIO_ID: ${{ env.SCENARIO_ID }}
        run: |
          : "${MAKE_BASE:=https://eu2.make.com}"
          : "${SCENARIO_ID:=unknown}"
          URL="${MAKE_BASE}/api/v2/scenarios/${SCENARIO_ID}"
          CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${MAKE_API_TOKEN}" "$URL" || echo "000")
          echo "code=$CODE" >> "$GITHUB_OUTPUT"

      - name: Telegram token check (ok only)
        id: tg
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          RESP=$(curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getMe" || true)
          OK=$(echo "$RESP" | jq -r '.ok // false')
          echo "ok=$OK" >> "$GITHUB_OUTPUT"

      - name: Write report
        run: |
          mkdir -p token_check_report
          cat > token_check_report/report.json <<EOF
          {
            "make_http_code": "${{ steps.make.outputs.code }}",
            "telegram_ok": "${{ steps.tg.outputs.ok }}"
          }
          EOF
          cat token_check_report/report.json

      - uses: actions/upload-artifact@v4
        with:
          name: token_check_report
          path: token_check_report
          if-no-files-found: error