name: Deploy GitHub Executor API v1

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "×ž××©×¨ ×›×ª×™×‘×”" to confirm deployment'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == '×ž××©×¨ ×›×ª×™×‘×”'
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/212701048029/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions@edri2or-mcp.iam.gserviceaccount.com'
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Verify GH_EX secret exists and is accessible
        run: |
          echo "Checking if GH_EX secret exists..."
          if gcloud secrets describe GH_EX --project=edri2or-mcp 2>/dev/null; then
            echo "âœ… GH_EX secret exists"
          else
            echo "âŒ ERROR: GH_EX secret not found"
            exit 1
          fi
          
          echo "Verifying service account can access GH_EX..."
          if gcloud secrets versions access latest --secret=GH_EX --project=edri2or-mcp > /dev/null 2>&1; then
            echo "âœ… Service account has access to GH_EX"
          else
            echo "âš ï¸  Service account cannot access GH_EX - granting permission..."
            gcloud secrets add-iam-policy-binding GH_EX \
              --project=edri2or-mcp \
              --member="serviceAccount:github-actions@edri2or-mcp.iam.gserviceaccount.com" \
              --role="roles/secretmanager.secretAccessor"
            
            echo "âœ… Permission granted - verifying again..."
            if gcloud secrets versions access latest --secret=GH_EX --project=edri2or-mcp > /dev/null 2>&1; then
              echo "âœ… Access confirmed"
            else
              echo "âŒ Still cannot access - check IAM permissions"
              exit 1
            fi
          fi
      
      - name: Deploy GitHub Executor API to Cloud Run
        run: |
          echo "Deploying GitHub Executor API v1..."
          cd cloud-run/google-workspace-github-api
          
          gcloud run deploy github-executor-api \
            --source=. \
            --region=us-central1 \
            --project=edri2or-mcp \
            --platform=managed \
            --allow-unauthenticated \
            --set-secrets=GITHUB_TOKEN=GH_EX:latest \
            --set-env-vars="GITHUB_OWNER=edri2or-commits,GITHUB_REPO=make-ops-clean" \
            --memory=512Mi \
            --cpu=1 \
            --max-instances=10 \
            --timeout=60s \
            --service-account=github-actions@edri2or-mcp.iam.gserviceaccount.com
          
          echo "âœ… Deployment complete"
      
      - name: Get service URL
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe github-executor-api \
            --region=us-central1 \
            --project=edri2or-mcp \
            --format='value(status.url)')
          
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Service URL: $SERVICE_URL"
      
      - name: Test health endpoint
        id: test-health
        run: |
          SERVICE_URL="${{ steps.get-url.outputs.service_url }}"
          echo "Testing health endpoint: $SERVICE_URL/"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "$SERVICE_URL/")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed"
            echo "health_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Health check failed"
            echo "health_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Test read-file endpoint (OS_SAFE)
        id: test-read
        run: |
          SERVICE_URL="${{ steps.get-url.outputs.service_url }}"
          echo "Testing read-file endpoint..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$SERVICE_URL/repo/read-file" \
            -H "Content-Type: application/json" \
            -d '{
              "owner": "edri2or-commits",
              "repo": "make-ops-clean",
              "path": "DOCS/QUICKSTART_STORE_GH_EX.md",
              "branch": "main"
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response preview: $(echo "$BODY" | head -c 200)..."
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Read file test passed"
            echo "read_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Read file test failed"
            echo "read_status=failed" >> $GITHUB_OUTPUT
          fi
      
      - name: Test update-doc endpoint (OS_SAFE)
        id: test-update
        run: |
          SERVICE_URL="${{ steps.get-url.outputs.service_url }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          echo "Testing update-doc endpoint..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$SERVICE_URL/repo/update-doc" \
            -H "Content-Type: application/json" \
            -d "{
              \"owner\": \"edri2or-commits\",
              \"repo\": \"make-ops-clean\",
              \"path\": \"OPS/EVIDENCE/github_executor_test_${TIMESTAMP//[:]/}.md\",
              \"content\": \"# GitHub Executor API Test\n\n**Timestamp**: $TIMESTAMP\n**Test**: Automated deployment verification\n**Status**: âœ… Service operational\n\",
              \"message\": \"ðŸ§ª GitHub Executor API v1 deployment test\",
              \"branch\": \"main\"
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "âœ… Update doc test passed"
            echo "update_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Update doc test failed"
            echo "update_status=failed" >> $GITHUB_OUTPUT
          fi
      
      - name: Create deployment evidence
        run: |
          mkdir -p OPS/EVIDENCE
          cat > OPS/EVIDENCE/github_executor_deployed_$(date +%Y%m%d_%H%M%S).json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "action": "deploy_github_executor_api_v1",
            "project": "edri2or-mcp",
            "region": "us-central1",
            "service_name": "github-executor-api",
            "service_url": "${{ steps.get-url.outputs.service_url }}",
            "secret_used": "GH_EX",
            "tests": {
              "health": "${{ steps.test-health.outputs.health_status }}",
              "read_file": "${{ steps.test-read.outputs.read_status }}",
              "update_doc": "${{ steps.test-update.outputs.update_status }}"
            },
            "workflow_run": "${{ github.run_id }}",
            "triggered_by": "${{ github.actor }}"
          }
          EOF
      
      - name: Upload evidence
        uses: actions/upload-artifact@v4
        with:
          name: github-executor-deployment-evidence
          path: OPS/EVIDENCE/github_executor_deployed_*.json
      
      - name: Summary
        run: |
          echo "## ðŸš€ GitHub Executor API v1 Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service URL**: ${{ steps.get-url.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region**: us-central1" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: edri2or-mcp" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Health Check: ${{ steps.test-health.outputs.health_status == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Read File: ${{ steps.test-read.outputs.read_status == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Update Doc: ${{ steps.test-update.outputs.update_status == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Step**: Update CAPABILITIES_MATRIX.md â†’ GitHub Executor API v1 = VERIFIED" >> $GITHUB_STEP_SUMMARY
