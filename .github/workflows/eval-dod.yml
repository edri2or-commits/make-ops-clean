name: eval-dod
on:
  pull_request:
    branches: [ main, or-control/ops ]
  workflow_dispatch:
permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  dod:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: ACCESS_TOKEN
        run: echo "ACCESS_TOKEN=$(gcloud auth print-access-token)" >> $GITHUB_ENV

      - name: Ensure test resources (ad-hoc)
        run: |
          set -euo pipefail
          if [ -z "${DOC_ID:-}" ]; then
            DOC_ID=$(curl -s -X POST -H "Authorization: Bearer $ACCESS_TOKEN" \
              -H "Content-Type: application/json" https://docs.googleapis.com/v1/documents \
              -d '{"title":"DoD Test Doc (CI)"}' | jq -r .documentId)
            curl -s -X POST -H "Authorization: Bearer $ACCESS_TOKEN" \
              -H "Content-Type: application/json" \
              "https://docs.googleapis.com/v1/documents/${DOC_ID}:batchUpdate" \
              -d '{"requests":[{"insertText":{"location":{"index":1},"text":"TODO"}}]}' >/dev/null
            echo "DOC_ID=$DOC_ID" >> $GITHUB_ENV
          fi
          if [ -z "${SHEET_ID:-}" ]; then
            SHEET_ID=$(curl -s -X POST -H "Authorization: Bearer $ACCESS_TOKEN" \
              -H "Content-Type: application/json" https://sheets.googleapis.com/v4/spreadsheets \
              -d '{"properties":{"title":"DoD Sheet (CI)"}}' | jq -r .spreadsheetId)
            echo "SHEET_ID=$SHEET_ID" >> $GITHUB_ENV
          fi

      - name: Docs replaceAllText (TODO->DONE)
        run: |
          curl -s -X POST -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            "https://docs.googleapis.com/v1/documents/${DOC_ID}:batchUpdate" \
            -d '{"requests":[{"replaceAllText":{"containsText":{"text":"TODO","matchCase":true},"replaceText":"DONE"}}]}' \
            | jq '.replies | length as $w | ($w|tostring) | "DOCS_WRITES="+.' -r >> $GITHUB_ENV

      - name: Sheets A1="שלום"
        run: |
          R=$(curl -s -X PUT -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            "https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A1?valueInputOption=RAW" \
            -d '{"values":[["שלום"]]}')
          echo "SHEETS_CELLS=$(echo "$R" | jq -r .updatedCells)" >> $GITHUB_ENV
          echo "SHEETS_RANGE=$(echo "$R" | jq -r .updatedRange)" >> $GITHUB_ENV

      - name: Append to Ledger (atomic x3)
        run: |
          set -euo pipefail
          ts=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          mkdir -p ops; [ -s ops/ledger.json ] || echo "[]" > ops/ledger.json
          DOCS=$(jq -n --arg ts "$ts" --arg sha "$GITHUB_SHA" --arg id "$DOC_ID" --arg w "$DOCS_WRITES" \
            '{id:(now|tostring),type:"docs.findReplace",timestamp:$ts,status:"success",actor:"github-actions",
              input:{documentId:$id,findText:"TODO",replaceText:"DONE"},
              output:{documentId:$id,writes:($w|tonumber)},commitSha:$sha}')
          SHEETS=$(jq -n --arg ts "$ts" --arg sha "$GITHUB_SHA" --arg id "$SHEET_ID" --arg c "$SHEETS_CELLS" --arg r "$SHEETS_RANGE" \
            '{id:(now|tostring),type:"sheets.values.update",timestamp:$ts,status:"success",actor:"github-actions",
              input:{spreadsheetId:$id,range:"A1",valueCount:1},
              output:{spreadsheetId:$id,updatedRange:$r,updatedCells:($c|tonumber)},commitSha:$sha}')
          for a in 1 2 3; do
            jq ". + [$DOCS, $SHEETS]" ops/ledger.json > ops/ledger.json.tmp && mv ops/ledger.json.tmp ops/ledger.json && break || sleep $a
          done
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ops/ledger.json && git commit -m "ledger: eval-dod" && git push

      - name: Auto-merge PR on success
        if: ${{ github.event_name == 'pull_request' && success() }}
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            await github.rest.pulls.merge({
              owner: context.repo.owner, repo: context.repo.repo,
              pull_number: pr.number, merge_method: 'squash'
            });
