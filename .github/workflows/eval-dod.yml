name: eval-dod
on:
  workflow_dispatch:
    inputs:
      target_ref:
        description: "Target branch for DoD"
        default: "feature/pr-9-workspace-smoke"
        required: false

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write

jobs:
  auth-selftest:
    runs-on: ubuntu-latest
    outputs:
      auth_ok: ${{ steps.verify.outputs.ok }}
    steps:
      - name: Checkout target ref
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_ref || 'feature/pr-9-workspace-smoke' }}

      - name: Auth via WIF (with retries)
        id: wif
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
        continue-on-error: true

      - name: Setup gcloud
        if: steps.wif.outcome == 'success'
        uses: google-github-actions/setup-gcloud@v2
        continue-on-error: true

      - name: Verify token (3 retries)
        id: verify
        run: |
          set +e
          for attempt in 1 2 3; do
            echo "Attempt $attempt/3 to get access token..."
            TOK=$(gcloud auth print-access-token 2>/dev/null || true)
            if [ -n "$TOK" ] && [ "${#TOK}" -gt 50 ]; then
              echo "âœ… Auth successful (token length: ${#TOK})"
              echo "ok=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            [ $attempt -lt 3 ] && sleep $((attempt * 2))
          done
          echo "âŒ Auth failed after 3 attempts"
          echo "ok=false" >> $GITHUB_OUTPUT

      - name: Ledger auth result
        run: |
          set -euo pipefail
          mkdir -p ops; [ -s ops/ledger.json ] || echo "[]" > ops/ledger.json
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          STATUS="${{ steps.verify.outputs.ok == 'true' && 'success' || 'failed' }}"
          ENTRY=$(jq -n --arg ts "$TS" --arg sha "$GITHUB_SHA" --arg status "$STATUS" \
            '{id:(now|tostring),type:"auth-test",timestamp:$ts,status:$status,
              actor:"github-actions",input:{provider:"WIF"},
              output:{verified:($status=="success")},commitSha:$sha}')
          jq ". + [$ENTRY]" ops/ledger.json > ops/ledger.json.tmp && mv ops/ledger.json.tmp ops/ledger.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ops/ledger.json && git commit -m "chore(ledger): auth-selftest $STATUS" && git push

      - name: Open bootstrap issue on failure
        if: steps.verify.outputs.ok != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const title = 'infra:bootstrap â€” configure WIF/SA';
            const body = `## WIF/SA Configuration Required
            
            Auth self-test failed in eval-dod workflow.
            
            **Missing/Invalid:**
            - \`WIF_PROVIDER\` secret
            - \`WIF_SERVICE_ACCOUNT\` secret
            - IAM roles: \`roles/iam.workloadIdentityUser\` + service-specific roles
            
            **Action Required:**
            1. Configure WIF provider in GCP
            2. Add GitHub secrets
            3. Verify IAM bindings
            
            **Context:**
            - Workflow: eval-dod
            - Run: ${{ github.run_id }}
            - Ref: ${{ inputs.target_ref || 'feature/pr-9-workspace-smoke' }}
            `;
            await github.rest.issues.create({owner, repo, title, body});

  dod:
    needs: auth-selftest
    if: needs.auth-selftest.outputs.auth_ok == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target ref
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_ref || 'feature/pr-9-workspace-smoke' }}

      - name: Auth via WIF
        id: wif
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Get ACCESS_TOKEN
        id: token
        run: |
          set -euo pipefail
          TOK=$(gcloud auth print-access-token)
          echo "ACCESS_TOKEN=$TOK" >> $GITHUB_ENV
          echo "âœ… Token acquired (length: ${#TOK})"

      - name: Docs DoD
        run: |
          set -euo pipefail
          DOC_ID=$(curl -s -H "Authorization: Bearer $ACCESS_TOKEN" -H "Content-Type: application/json" \
            -d '{"title":"DoD Test Doc (CI)"}' https://docs.googleapis.com/v1/documents | jq -r .documentId)
          curl -s -H "Authorization: Bearer $ACCESS_TOKEN" -H "Content-Type: application/json" \
            -d '{"requests":[{"insertText":{"location":{"index":1},"text":"TODO"}}]}' \
            "https://docs.googleapis.com/v1/documents/${DOC_ID}:batchUpdate" >/dev/null
          REPLIES=$(curl -s -H "Authorization: Bearer $ACCESS_TOKEN" -H "Content-Type: application/json" \
            -d '{"requests":[{"replaceAllText":{"containsText":{"text":"TODO","matchCase":true},"replaceText":"DONE"}}]}' \
            "https://docs.googleapis.com/v1/documents/${DOC_ID}:batchUpdate" | jq '.replies | length')
          echo "DOC_ID=$DOC_ID" >> $GITHUB_ENV
          echo "DOCS_WRITES=$REPLIES" >> $GITHUB_ENV
          echo "âœ… Docs: replaceAllText TODOâ†’DONE (writes: $REPLIES)"

      - name: Sheets DoD
        run: |
          set -euo pipefail
          SHEET_ID=$(curl -s -H "Authorization: Bearer $ACCESS_TOKEN" -H "Content-Type: application/json" \
            -d '{"properties":{"title":"DoD Test Sheet (CI)"}}' https://sheets.googleapis.com/v4/spreadsheets | jq -r .spreadsheetId)
          RES=$(curl -s -X PUT -H "Authorization: Bearer $ACCESS_TOKEN" -H "Content-Type: application/json" \
            -d '{"values":[["×©×œ×•×"]]}' \
            "https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A1?valueInputOption=USER_ENTERED")
          CELLS=$(echo "$RES" | jq -r '.updatedCells')
          echo "SHEET_ID=$SHEET_ID" >> $GITHUB_ENV
          echo "SHEETS_CELLS=$CELLS" >> $GITHUB_ENV
          echo "âœ… Sheets: updated A1='×©×œ×•×' (cells: $CELLS)"

      - name: Drive DoD
        run: |
          set -euo pipefail
          TS=$(date +%s)
          META=$(printf '%s' '{"name":"smoke-'"$TS"'.txt","mimeType":"text/plain"}' | jq -c .)
          FILE_ID=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -F "metadata=$META;type=application/json; charset=UTF-8" \
            -F "file=@/etc/hostname;type=text/plain" \
            "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart" | jq -r .id)
          echo "DRIVE_FILE_ID=$FILE_ID" >> $GITHUB_ENV
          echo "âœ… Drive: created smoke-$TS.txt (id: $FILE_ID)"

      - name: Gmail/Calendar status
        run: |
          echo "â„¹ï¸  Gmail: skipped (OAuth not configured)"
          echo "â„¹ï¸  Calendar: skipped (OAuth not configured)"

      - name: Ledger append (atomic Ã—3)
        run: |
          set -euo pipefail
          mkdir -p ops; [ -s ops/ledger.json ] || echo "[]" > ops/ledger.json
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          DOC=$(jq -n --arg ts "$TS" --arg sha "$GITHUB_SHA" --arg id "$DOC_ID" --arg w "$DOCS_WRITES" \
            '{id:(now|tostring),type:"docs.findReplace",timestamp:$ts,status:"success",actor:"github-actions",
              input:{documentId:$id,findText:"TODO",replaceText:"DONE"},
              output:{documentId:$id,writes:($w|tonumber)},commitSha:$sha}')
          SHT=$(jq -n --arg ts "$TS" --arg sha "$GITHUB_SHA" --arg id "$SHEET_ID" --arg c "$SHEETS_CELLS" \
            '{id:(now|tostring),type:"sheets.values.update",timestamp:$ts,status:"success",actor:"github-actions",
              input:{spreadsheetId:$id,range:"A1",valueCount:1},
              output:{spreadsheetId:$id,updatedCells:($c|tonumber)},commitSha:$sha}')
          DRV=$(jq -n --arg ts "$TS" --arg sha "$GITHUB_SHA" --arg id "$DRIVE_FILE_ID" \
            '{id:(now|tostring),type:"drive.create",timestamp:$ts,status:"success",actor:"github-actions",
              input:{kind:"file","mimeType":"text/plain"},output:{fileId:$id},commitSha:$sha}')
          GMAIL=$(jq -n --arg ts "$TS" --arg sha "$GITHUB_SHA" \
            '{id:(now|tostring),type:"gmail.send",timestamp:$ts,status:"skipped",actor:"github-actions",
              input:{},output:{reason:"OAuth not configured"},commitSha:$sha}')
          CAL=$(jq -n --arg ts "$TS" --arg sha "$GITHUB_SHA" \
            '{id:(now|tostring),type:"calendar.create",timestamp:$ts,status:"skipped",actor:"github-actions",
              input:{},output:{reason:"OAuth not configured"},commitSha:$sha}')
          
          for attempt in 1 2 3; do
            jq ". + [$DOC, $SHT, $DRV, $GMAIL, $CAL]" ops/ledger.json > ops/ledger.json.tmp && \
              mv ops/ledger.json.tmp ops/ledger.json && break || sleep $((attempt * 2))
            [ $attempt -eq 3 ] && exit 1
          done
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ops/ledger.json && git commit -m "chore(ledger): DoD complete â€” Docs/Sheets/Drive" && git push
          echo "âœ… Ledger: 5 entries written atomically"

      - name: Find PR for target ref
        id: find_pr
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const ref = '${{ inputs.target_ref || 'feature/pr-9-workspace-smoke' }}';
            const {data: prs} = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${ref}`
            });
            if (prs.length > 0) {
              core.setOutput('pr_number', prs[0].number);
              core.setOutput('found', 'true');
              console.log(`Found PR #${prs[0].number}`);
            } else {
              core.setOutput('found', 'false');
              console.log('No PR found for ref');
            }

      - name: Comment on PR with results
        if: steps.find_pr.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.find_pr.outputs.pr_number }};
            const body = `## ğŸ¯ DoD Execution Complete
            
            **Status:** âœ… All checks passed
            
            **Resources Created:**
            - ğŸ“„ **Docs**: \`${{ env.DOC_ID }}\` (replaceAllText: ${{ env.DOCS_WRITES }} writes)
            - ğŸ“Š **Sheets**: \`${{ env.SHEET_ID }}\` (updated ${{ env.SHEETS_CELLS }} cells)
            - ğŸ“¦ **Drive**: \`${{ env.DRIVE_FILE_ID }}\` (smoke test file)
            - ğŸ“§ **Gmail**: skipped (OAuth not configured)
            - ğŸ“… **Calendar**: skipped (OAuth not configured)
            
            **Ledger Tail (last 5 entries):**
            \`\`\`json
            See ops/ledger.json for full audit trail
            \`\`\`
            
            **Next:** Auto-merge in progress...
            `;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });

      - name: Auto-merge PR
        if: steps.find_pr.outputs.found == 'true' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.find_pr.outputs.pr_number }};
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: 'feat: workspace DoD automation (Docs/Sheets/Drive)',
                commit_message: 'Zero-Touch autonomous control loop implementation'
              });
              console.log(`âœ… PR #${prNumber} merged successfully`);
            } catch (error) {
              console.error(`âŒ Merge failed: ${error.message}`);
              throw error;
            }
