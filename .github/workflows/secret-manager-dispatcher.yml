name: Secret Manager Job Dispatcher

on:
  push:
    paths:
      - 'jobs/requests/secret-manager-*.json'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  dispatch:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect new Secret Manager job requests
        id: detect
        run: |
          echo "=== Detecting New Secret Manager Job Requests ===" 
          
          # Get changed files matching secret-manager pattern
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep '^jobs/requests/secret-manager-.*\.json$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No new Secret Manager job requests detected"
            echo "has_jobs=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "New Secret Manager job requests detected:"
          echo "$CHANGED_FILES"
          
          # Take first job file for this run
          JOB_FILE=$(echo "$CHANGED_FILES" | head -n 1)
          echo "Processing: $JOB_FILE"
          echo "job_file=$JOB_FILE" >> "$GITHUB_OUTPUT"
          echo "has_jobs=true" >> "$GITHUB_OUTPUT"

      - name: Parse job request
        if: steps.detect.outputs.has_jobs == 'true'
        id: parse
        run: |
          JOB_FILE="${{ steps.detect.outputs.job_file }}"
          
          echo "=== Parsing Secret Manager Job Request: $JOB_FILE ==="
          
          # Validate JSON
          if ! jq empty "$JOB_FILE" 2>/dev/null; then
            echo "ERROR: Invalid JSON in $JOB_FILE"
            exit 1
          fi
          
          # Extract fields
          TYPE=$(jq -r '.type' "$JOB_FILE")
          REQUEST_ID=$(jq -r '.request_id' "$JOB_FILE")
          ACTION=$(jq -r '.action' "$JOB_FILE")
          SECRET_ID=$(jq -r '.secret_id' "$JOB_FILE")
          SECRET_VALUE=$(jq -r '.secret_value // ""' "$JOB_FILE")
          PROJECT_ID=$(jq -r '.project_id // "edri2or-mcp"' "$JOB_FILE")
          
          echo "Type: $TYPE"
          echo "Request ID: $REQUEST_ID"
          echo "Action: $ACTION"
          echo "Secret ID: $SECRET_ID"
          echo "Project ID: $PROJECT_ID"
          
          # Validate required fields
          if [ "$TYPE" != "secret_manager" ]; then
            echo "ERROR: Invalid type: $TYPE (expected: secret_manager)"
            exit 1
          fi
          
          if [ "$REQUEST_ID" = "null" ] || [ "$ACTION" = "null" ] || [ "$SECRET_ID" = "null" ]; then
            echo "ERROR: Missing required fields (request_id, action, secret_id)"
            exit 1
          fi
          
          # Validate action
          case "$ACTION" in
            read|create|update|create_or_update)
              echo "Valid action: $ACTION"
              ;;
            *)
              echo "ERROR: Invalid action: $ACTION"
              echo "Must be one of: read, create, update, create_or_update"
              exit 1
              ;;
          esac
          
          # Set outputs
          echo "type=$TYPE" >> "$GITHUB_OUTPUT"
          echo "request_id=$REQUEST_ID" >> "$GITHUB_OUTPUT"
          echo "action=$ACTION" >> "$GITHUB_OUTPUT"
          echo "secret_id=$SECRET_ID" >> "$GITHUB_OUTPUT"
          echo "project_id=$PROJECT_ID" >> "$GITHUB_OUTPUT"
          
          # Store secret_value for workflow_call (if provided)
          if [ -n "$SECRET_VALUE" ]; then
            echo "secret_value=$SECRET_VALUE" >> "$GITHUB_OUTPUT"
          else
            echo "secret_value=" >> "$GITHUB_OUTPUT"
          fi

  execute:
    needs: dispatch
    if: needs.dispatch.outputs.has_jobs == 'true'
    uses: ./.github/workflows/secret-manager-ops.yml
    with:
      action: ${{ needs.dispatch.outputs.action }}
      secret_id: ${{ needs.dispatch.outputs.secret_id }}
      secret_value: ${{ needs.dispatch.outputs.secret_value }}
      project_id: ${{ needs.dispatch.outputs.project_id }}
    secrets: inherit

  write_result:
    needs: [dispatch, execute]
    runs-on: ubuntu-latest
    if: always() && needs.dispatch.outputs.has_jobs == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Write result file
        run: |
          REQUEST_ID="${{ needs.dispatch.outputs.request_id }}"
          ACTION="${{ needs.dispatch.outputs.action }}"
          SECRET_ID="${{ needs.dispatch.outputs.secret_id }}"
          STATUS="${{ needs.execute.outputs.status }}"
          ERROR="${{ needs.execute.outputs.error }}"
          
          echo "=== Writing Result File ==="
          echo "Request ID: $REQUEST_ID"
          echo "Action: $ACTION"
          echo "Status: $STATUS"
          
          # Create result JSON
          cat > "jobs/results/${REQUEST_ID}.json" <<EOF
          {
            "request_id": "$REQUEST_ID",
            "type": "secret_manager",
            "action": "$ACTION",
            "secret_id": "$SECRET_ID",
            "status": "$STATUS",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "github_run_id": "${{ github.run_id }}",
            "github_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "error": "$ERROR"
          }
          EOF
          
          echo "Result written to jobs/results/${REQUEST_ID}.json"
          cat "jobs/results/${REQUEST_ID}.json"

      - name: Commit result file
        run: |
          REQUEST_ID="${{ needs.dispatch.outputs.request_id }}"
          
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions - Secret Manager Dispatcher"
          git add "jobs/results/${REQUEST_ID}.json"
          git commit -m "L1: secret manager result - ${REQUEST_ID}" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Upload result artifact
        uses: actions/upload-artifact@v4
        with:
          name: secret-manager-result-${{ needs.dispatch.outputs.request_id }}
          path: jobs/results/${{ needs.dispatch.outputs.request_id }}.json
          retention-days: 30

      - name: Summary
        run: |
          REQUEST_ID="${{ needs.dispatch.outputs.request_id }}"
          ACTION="${{ needs.dispatch.outputs.action }}"
          SECRET_ID="${{ needs.dispatch.outputs.secret_id }}"
          STATUS="${{ needs.execute.outputs.status }}"
          ERROR="${{ needs.execute.outputs.error }}"
          
          cat >> "$GITHUB_STEP_SUMMARY" <<SUMMARY
          ## Secret Manager Job Summary
          
          **Request ID**: \`$REQUEST_ID\`  
          **Action**: \`$ACTION\`  
          **Secret ID**: \`$SECRET_ID\`  
          **Status**: \`$STATUS\`
          
          $(if [ "$STATUS" = "failure" ]; then
            echo "**Error**: $ERROR"
          else
            echo "âœ… Operation completed successfully"
          fi)
          
          **Result File**: \`jobs/results/${REQUEST_ID}.json\`  
          **Run URL**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SUMMARY
