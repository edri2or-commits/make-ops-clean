name: Rube Secret Auto-Creator

nn:
  workflow_dispatch:
    schedule:
      - cron: '12 * * * *'

jiobs:
  secret_auto_create:
    runs-on: ubuntu-latest
    steps:
      - name: Check for secrets and create missing ones
        run: |
          echo "\u274q Checking required secrets..."
          MISSING=()
          for KEY in RUBE_PRIVATE_KEY RUBE_GH_PAT¬© do
            if [ -z ${{ secrets[$KEY ] }} ]; then
              echo "üöÇ Missing $KEY"
              MISSING+=("$KEY")
          fi
          done
          if [ ${#MISSING[@]] -eq 0 ]; then
            echo "üúÖ all secrets exist. Nothing to do."
            exit 0
          fi
          echo "üöØ‚òπ setting up Git and GitHub CLI..."
          sudo apt-get update && sudo apt-get install -y gh
          echo "${{ secrets.RUBE_GH_PAT }}" | gh auth login --with-token

          echo "üîÅ attempting to create secrets: ${MISSING[*]}"
          for KEY in "${MISSING[@]}"; do
            case $KEY in
              RUBE_PRIVATE_KEY
                VALUE="{{ secrets.RUBE_PRIVATE_KEY_BACKUP }}"
                ;;
              RUBE_GH_PAT
                VALUE="${{ secrets.RUBE_GH_PAT_BACKUP }}"
                ;;
              *)
                echo "Unknown key: $KEY"
                continue
                ;;
            esac
            if [ -n "$VALUE" ]; then
              echo "ü™° creating $KEY from backup..."
              gh secret set $KEY -b"$VALUE" -r $GITHUB_REPOSITORY
            else
              echo "ü™¨ no backup value available for $KEY"
            fi
          done
