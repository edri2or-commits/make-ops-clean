name: auditor-smoke
on:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Write PEM to file (from secret)
        run: |
          cat > key.pem <<'PEM'
          ${{ secrets.GH_APP_PRIVATE_KEY_PEM }}
          PEM
          chmod 600 key.pem

      - name: Mint installation token (JWT -> token)
        id: mint
        env:
          APP_ID: ${{ secrets.GH_APP_ID_AUDITOR }}
          INSTALLATION_ID: ${{ secrets.GH_APP_INSTALLATION_ID }}
        run: |
          b64() { openssl base64 -A | tr '+/' '-_' | tr -d '='; }
          iat=$(date +%s); exp=$((iat+540))
          header='{"alg":"RS256","typ":"JWT"}'
          payload=$(printf '{"iat":%s,"exp":%s,"iss":"%s"}' "$iat" "$exp" "$APP_ID")
          unsigned="$(printf '%s' "$header" | b64).$(printf '%s' "$payload" | b64)"
          signature=$(printf '%s' "$unsigned" | openssl dgst -sha256 -sign key.pem -binary | b64)
          JWT="$unsigned.$signature"

          curl -sX POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $JWT" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/app/installations/$INSTALLATION_ID/access_tokens" > token.json

          token=$(python3 - <<'PY'
import json; print(json.load(open("token.json"))["token"])
PY
)
          echo "::add-mask::$token"
          echo "token=$token" >> $GITHUB_OUTPUT

      - name: Prove access (repo info + runs + download logs)
        env:
          TOKEN: ${{ steps.mint.outputs.token }}
          OWNER: edri2or-commits
          REPO: make-ops-clean
        run: |
          # Repo info
          curl -sL -H "Authorization: Bearer $TOKEN" \
               -H "Accept: application/vnd.github+json" \
               -H "X-GitHub-Api-Version: 2022-11-28" \
               "https://api.github.com/repos/$OWNER/$REPO" \
            | python3 - <<'PY' | tee -a $GITHUB_STEP_SUMMARY
import json,sys; d=json.load(sys.stdin)
print(f"repo_full_name: {d['full_name']}")
PY

          # Runs list
          curl -sL -H "Authorization: Bearer $TOKEN" \
               -H "Accept: application/vnd.github+json" \
               -H "X-GitHub-Api-Version: 2022-11-28" \
               "https://api.github.com/repos/$OWNER/$REPO/actions/runs" > runs.json

          python3 - <<'PY' | tee -a $GITHUB_STEP_SUMMARY
import json; d=json.load(open("runs.json"))
n=d.get("total_count",0); rid=d["workflow_runs"][0]["id"] if n else None
print(f"runs_total: {n}")
print(f"latest_run_id: {rid}")
PY

          # Download logs of latest run (if exists)
          rid=$(python3 - <<'PY'
import json; d=json.load(open("runs.json"))
print(d["workflow_runs"][0]["id"] if d.get("workflow_runs") else "")
PY
)
          if [ -n "$rid" ]; then
            curl -sL -H "Authorization: Bearer $TOKEN" \
                 -H "Accept: application/vnd.github+json" \
                 -H "X-GitHub-Api-Version: 2022-11-28" \
                 "https://api.github.com/repos/$OWNER/$REPO/actions/runs/$rid/logs" -o logs.zip
          fi

      - name: Upload logs (if any)
        if: hashFiles('logs.zip') != ''
        uses: actions/upload-artifact@v4
        with:
          name: logs
          path: logs.zip
