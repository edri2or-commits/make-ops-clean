name: admin-apply-settings
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: [ ".github/workflows/admin-apply-settings.yml" ]
  schedule:
    - cron: "0 1 * * *"
  pull_request_target:
    branches: [ main ]
permissions:
  contents: write
  pull-requests: write
  actions: read
jobs:
  enforce:
    runs-on: ubuntu-latest
    steps:
      - name: Enable security flags
        env:
          GH_TOKEN: ${{ secrets.ADMIN_PAT }}
        run: |
          set -euo pipefail
          payload='{"security_and_analysis":{"secret_scanning":{"status":"enabled"},"secret_scanning_push_protection":{"status":"enabled"},"secret_scanning_validity_checks":{"status":"enabled"},"secret_scanning_non_provider_patterns":{"status":"enabled"},"dependabot_security_updates":{"status":"enabled"}}}'
          echo "$payload" | gh api -X PATCH repos/$GITHUB_REPOSITORY \
            -H 'Accept: application/vnd.github+json' -H 'Content-Type: application/json' --input -
      - name: Verify security flags
        env:
          GH_TOKEN: ${{ secrets.ADMIN_PAT }}
        run: |
          set -euo pipefail
          gh api repos/$GITHUB_REPOSITORY --jq '.security_and_analysis |
            [ .secret_scanning.status,
              .secret_scanning_push_protection.status,
              .secret_scanning_validity_checks.status,
              .secret_scanning_non_provider_patterns.status,
              .dependabot_security_updates.status ] | all(.=="enabled")' | grep -q true
