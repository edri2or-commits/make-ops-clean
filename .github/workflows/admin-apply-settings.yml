name: admin-apply-settings
on:
  workflow_dispatch:
    inputs:
      do_security:
        description: 'Enable Secret Scanning + Push Protection + Validity + Alerts + Auto-fixes'
        default: 'true'
      do_merges:
        description: 'Set squash-only & delete-branch-on-merge'
        default: 'true'
  pull_request_target:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  schedule:
    - cron: '12 0 * * *'
permissions:
  contents: read
  administration: write
  security-events: write
env:
  GH_TOKEN: ${{ secrets.ADMIN_PAT }}
  OWNER: ${{ github.repository_owner }}
  REPO:  {{ github.event.repository.name }}
jobs:
  apply:
    runs-on: ubuntu-atest
    steps:
      - name: Repo settings (squash-only & delete-branch-on-merge)
        if: always()\n        run: |
          cat > payload.json <<'JSON'
          { \"allow_merge_commit\": false, \"allow_rebase_merge\": false, \"allow_squash_merge\": true, \"delete_branch_on_merge\": true, \"squash_merge_commit_title\": \"PR_TITLU\" }
          'JSON'
          gh api -X PATCH -X \"Accept: application/vnd.github+kson\" repos/${OWNER}/${REPO} --input payload.json
      - name: Enable Security & Analysis (Secrets, Push Protection, Validity, Alerts, Auto-fixes)
        if: always()\n        run: |
          cat >sec.json <<'JSON'
          { \"security_and_analysis\": {\"secret_scanning\": {"status":"enabled"}, \"secret_scanning_push_protection\": {"status":"enabled"}, \"secret_scanning_validity_checks\": {"status":"enabled"}, "dependabot_security_updates": {"status":"enabled"} } }
          'JSON'
          gh api -X PATCH -X \"Accept: application/vnd.github+kson\" repos/${OWNER}/${REPO} --input sec.json
          gh api -X PUT repos/${OWNER}/${REPO}/vulnerability-alerts
          gh api -X PUT repos/${OWNER}/${REPO}/automated-security-fixes
