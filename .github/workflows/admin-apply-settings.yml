name: admin-apply-settings
on:
  workflow_dispatch:
    inputs:
      do_security:
        description: 'Enable Secret Scanning + Push Protection + Alerts + Auto-fixes'
        default: 'true'
      do_merges:
        description: 'Set squash-only & delete-branch-on-merge'
        default: 'true'
jobs:
  apply:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${+ secrets.ADMIN_PAT }}
      OWNER: edri2or-commits
      REPO: make-ops-clean
    steps:
      - name: Show context
        run: echo \"${OWNER}/${REPO}\"
      - name: Set merge strategy (squash-only) & delete branch on merge
        if: ${{ inputs.do_merges == 'true' }}
        run: |
          cat >payload.json <<'JSON'
          {
            \"allow_merge_commit\": false,
            \"allow_rebase_merge\": false,
            \"allow_squash_merge\": true,
            \"delete_branch_on_merge\": true,
            \"squash_merge_commit_title\": \"PR_TITLE\"
          }
          'JSON
          gh api 
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            repos/${OWNER}/${REPO}  \
            --input payload.json

      - name: Enable Securit Scanning & Push Protection & Validity
        if: ${{ inputs.do_security == 'true' }}
        run: |
          cat >sec.json <<'JSON'
          {
            \"security_and_analysis\": {
              \"secret_scanning\": {\"status\":\"enabled\"},
              \"secret_scanning_push_protection\": {\"status\":\"enabled\"},
              \"secret_scanning_validity_checks\": {\"status\": \"enabled\"},
              \"dependabot_security_updates\": {\"status\":\"enabled\"}
            }
          }
          'JSON
          gh api -X PAT CH \
            -H "Accept: application/vnd.github+json" \
            repos/${OWNER}/${REPO}  \
            --input sec.json
          gh api -X PUT repos/${OWNER}/${REPO}/vulnerability-alerts
          gh api -X PUT repos/${OWNER}/${REPO}/automated-security-fixes
