name: ops-enforce
on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: "30 1 * * *"
permissions:
  contents: read
jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Verify repo merge settings
        env:
          GH_TOKEN: ${{ secrets.ADMIN_PAT }}
        run: |
          set -euo pipefail
          gh api repos/$GITHUB_REPOSITORY --jq '
            [ .allow_squash_merge==true,
              .allow_merge_commit==false,
              .allow_rebase_merge==false,
              .delete_branch_on_merge==true ] | all(.==true)' | grep -q true
      - name: Verify security flags
        env:
          GH_TOKEN: ${{ secrets.ADMIN_PAT }}
        run: |
          set -euo pipefail
          gh api repos/$GITHUB_REPOSITORY --jq '.security_and_analysis |
            [ .secret_scanning.status,
              .secret_scanning_push_protection.status,
              .secret_scanning_validity_checks.status,
              .secret_scanning_non_provider_patterns.status,
              .dependabot_security_updates.status ] | all(.=="enabled")' | grep -q true
      - name: Verify branch protection (main)
        env:
          GH_TOKEN: ${{ secrets.ADMIN_PAT }}
        run: |
          set -euo pipefail
          gh api repos/$GITHUB_REPOSITORY/branches/main/protection --jq '
            [ .enforce_admins.enabled,
              .required_linear_history.enabled,
              .required_conversation_resolution.enabled,
              (.allow_force_pushes.enabled | not) ] | all(.==true)' | grep -q true
