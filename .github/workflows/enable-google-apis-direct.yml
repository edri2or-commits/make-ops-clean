name: Enable Google APIs (Direct)

on:
  workflow_dispatch:
  push:
    paths:
      - '.ops/state/enable-apis-trigger.flag'

permissions:
  contents: write
  id-token: write

jobs:
  enable-apis:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER_PATH }}
          service_account: ${{ vars.GCP_SA_EMAIL }}
      
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: edri2or-mcp
      
      - name: Make script executable
        run: chmod +x .ops/scripts/enable-google-apis.sh
      
      - name: Run enablement script
        id: enable
        run: |
          bash .ops/scripts/enable-google-apis.sh
      
      - name: Commit results
        run: |
          git config user.name "Claude Automation"
          git config user.email "automation@claude-ops.local"
          git add .ops/results/google-apis-phase1.json
          git commit -m "L2 Phase 1: Google APIs enabled [automated]" || true
          git push || true
