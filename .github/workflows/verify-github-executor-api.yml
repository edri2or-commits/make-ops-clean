name: Verify Cloud Run Service - github-executor-api

on:
  workflow_dispatch:
    inputs:
      service_name:
        description: 'Cloud Run service name'
        required: false
        default: 'github-executor-api'
  push:
    paths:
      - 'OPS/TRIGGERS/github-executor-verify.trigger'

permissions:
  contents: write  # Required to commit status file
  id-token: write  # Required for WIF

jobs:
  verify-service:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER_PATH }}
          service_account: ${{ vars.GCP_SA_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify service exists
        id: verify
        continue-on-error: true
        run: |
          echo "Checking if service exists..."
          SERVICE_NAME="${{ inputs.service_name }}"
          if [ -z "$SERVICE_NAME" ]; then
            SERVICE_NAME="github-executor-api"
          fi
          
          gcloud run services describe "$SERVICE_NAME" \
            --region=us-central1 \
            --project=edri2or-mcp \
            --format=json > service-info.json
          
          if [ $? -eq 0 ]; then
            echo "service_exists=true" >> $GITHUB_OUTPUT
            echo "✅ Service found"
            
            # Extract key information
            SERVICE_URL=$(jq -r '.status.url // "N/A"' service-info.json)
            LAST_UPDATE=$(jq -r '.metadata.annotations."serving.knative.dev/lastModifier" // "N/A"' service-info.json)
            REVISION=$(jq -r '.status.latestReadyRevisionName // "N/A"' service-info.json)
            IMAGE=$(jq -r '.spec.template.spec.containers[0].image // "N/A"' service-info.json)
            
            echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
            echo "last_update=$LAST_UPDATE" >> $GITHUB_OUTPUT
            echo "revision=$REVISION" >> $GITHUB_OUTPUT
            echo "image=$IMAGE" >> $GITHUB_OUTPUT
            
            echo "Service URL: $SERVICE_URL"
            echo "Last Update: $LAST_UPDATE"
            echo "Latest Revision: $REVISION"
            echo "Image: $IMAGE"
            
            # Extract env var names
            ENV_VARS=$(jq -r '.spec.template.spec.containers[0].env[]? | .name' service-info.json | paste -sd "," - || echo "none")
            echo "env_vars=$ENV_VARS" >> $GITHUB_OUTPUT
            echo "Environment Variables: $ENV_VARS"
          else
            echo "service_exists=false" >> $GITHUB_OUTPUT
            echo "❌ Service NOT found"
            echo "This is expected if service was never deployed"
          fi

      - name: Create status file
        run: |
          mkdir -p OPS/STATUS
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          if [ "${{ steps.verify.outputs.service_exists }}" == "true" ]; then
            cat > OPS/STATUS/github-executor-api-verify.json <<EOF
          {
            "task": "2.1",
            "service_name": "github-executor-api",
            "timestamp": "$TIMESTAMP",
            "status": "deployed",
            "service_url": "${{ steps.verify.outputs.service_url }}",
            "revision": "${{ steps.verify.outputs.revision }}",
            "last_update": "${{ steps.verify.outputs.last_update }}",
            "image": "${{ steps.verify.outputs.image }}",
            "environment_variables": "${{ steps.verify.outputs.env_vars }}",
            "workflow_run": "${{ github.run_id }}",
            "workflow_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          else
            cat > OPS/STATUS/github-executor-api-verify.json <<EOF
          {
            "task": "2.1",
            "service_name": "github-executor-api",
            "timestamp": "$TIMESTAMP",
            "status": "not_deployed",
            "message": "Service does not exist in Cloud Run",
            "next_step": "Task 2.3 - Deploy Service",
            "workflow_run": "${{ github.run_id }}",
            "workflow_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          fi
          
          echo "Status file created:"
          cat OPS/STATUS/github-executor-api-verify.json

      - name: Create human-readable summary
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          cat > OPS/STATUS/github-executor-api-verify.md <<EOF
          # GitHub Executor API - Verification Status
          
          **Task**: 2.1 - Verify Deployment Status  
          **Timestamp**: $TIMESTAMP  
          **Workflow Run**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          
          EOF
          
          if [ "${{ steps.verify.outputs.service_exists }}" == "true" ]; then
            cat >> OPS/STATUS/github-executor-api-verify.md <<EOF
          ## ✅ Service Found
          
          The service **github-executor-api** is deployed in Cloud Run.
          
          ### Details
          
          - **URL**: ${{ steps.verify.outputs.service_url }}
          - **Latest Revision**: ${{ steps.verify.outputs.revision }}
          - **Last Modified**: ${{ steps.verify.outputs.last_update }}
          - **Image**: ${{ steps.verify.outputs.image }}
          
          ### Environment Variables
          
          \`\`\`
          ${{ steps.verify.outputs.env_vars }}
          \`\`\`
          
          ### Next Steps
          
          1. Review service configuration
          2. Proceed to Task 2.2 (Fix Accept header typo)
          3. Test endpoint (Task 2.5)
          
          EOF
          else
            cat >> OPS/STATUS/github-executor-api-verify.md <<EOF
          ## ❌ Service Not Found
          
          The service **github-executor-api** is NOT deployed in Cloud Run.
          
          ### Next Steps
          
          1. Proceed to Task 2.3 (Deploy Service)
          2. Use cloudbuild.yaml to deploy
          3. Verify deployment with this workflow again
          
          EOF
          fi
          
          echo "Human-readable summary created"

      - name: Commit status files to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add OPS/STATUS/github-executor-api-verify.json
          git add OPS/STATUS/github-executor-api-verify.md
          git commit -m "Task 2.1: Automated verification status update [skip ci]" || echo "No changes to commit"
          git push

      - name: Upload service info artifact (if exists)
        if: steps.verify.outputs.service_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cloud-run-service-info
          path: service-info.json
          retention-days: 30

      - name: Create workflow summary
        run: |
          {
            echo "# Task 2.1 - Verification Complete"
            echo ""
            echo "**Status File Created**: \`OPS/STATUS/github-executor-api-verify.json\`"
            echo ""
            
            if [ "${{ steps.verify.outputs.service_exists }}" == "true" ]; then
              echo "## ✅ Service Deployed"
              echo ""
              echo "- URL: ${{ steps.verify.outputs.service_url }}"
              echo "- Revision: ${{ steps.verify.outputs.revision }}"
            else
              echo "## ❌ Service Not Deployed"
              echo ""
              echo "Next: Task 2.3 (Deploy Service)"
            fi
            
            echo ""
            echo "**Claude can now read**: \`OPS/STATUS/github-executor-api-verify.json\`"
          } >> $GITHUB_STEP_SUMMARY
