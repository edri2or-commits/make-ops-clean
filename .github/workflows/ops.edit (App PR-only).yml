name: ops.edit (PR-only via GitHub App)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [ops.edit]

permissions:
  contents: read
  pull-requests: read

jobs:
  pr_only:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PRIVATE_KEY format (no output of secrets)
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          set -euo pipefail
          printf '%s' "$PRIVATE_KEY" > key.pem
          # fails if not a valid PEM; prints nothing
          openssl pkey -in key.pem -noout >/dev/null

      - name: Create GitHub App installation token
        id: app
        uses: actions/create-github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}            # או המספר של האפליקציה
          private_key: ${{ secrets.PRIVATE_KEY }}  # ה-PEM מה-GitHub App

      - name: Create branch, add file, open PR (curl only)
        id: pr
        env:
          GH_TOKEN: ${{ steps.app.outputs.token }}
          API: https://api.github.com
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY}"

          # 1) fetch default branch
          BASE=$(
            curl -sS \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$API/repos/$REPO" | jq -r '.default_branch'
          )
          test -n "$BASE" -a "$BASE" != "null"

          # 2) get base SHA
          BASE_SHA=$(
            curl -sS \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$API/repos/$REPO/git/ref/heads/$BASE" | jq -r '.object.sha'
          )
          test -n "$BASE_SHA" -a "$BASE_SHA" != "null"

          # 3) create branch
          TS=$(date -u +%Y%m%dT%H%M%SZ)
          BR="ops/$TS"
          curl -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API/repos/$REPO/git/refs" \
            -d "{\"ref\":\"refs/heads/$BR\",\"sha\":\"$BASE_SHA\"}" \
            || echo "note: branch may exist already"

          # 4) add file
          FILE=".chatops/runs/$TS.txt"
          CONTENT=$(printf "PR proof via App Installation at %s\n" "$TS" | base64 -w 0)
          curl -sS -X PUT \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API/repos/$REPO/contents/$FILE" \
            -d "{\"message\":\"chore(chatops): e2e proof (no-merge)\",\"content\":\"$CONTENT\",\"branch\":\"$BR\"}"

          # 5) open PR
          RESP=$(
            curl -sS -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$API/repos/$REPO/pulls" \
              -d "{\"title\":\"chatops: e2e proof (no-merge)\",\"head\":\"$BR\",\"base\":\"$BASE\"}"
          )
          URL=$(echo "$RESP" | jq -r '.html_url')
          test -n "$URL" -a "$URL" != "null"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "PR: $URL"
