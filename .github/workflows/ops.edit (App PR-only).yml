name: Ops Edit (PR-only via GitHub App)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [ops.edit]

# משאירים את GITHUB_TOKEN לקריאה בלבד — הכתיבה נעשית עם טוקן התקנה של ה-App
permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ops-edit-pr-only
  cancel-in-progress: true

jobs:
  pr_only:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
      - name: Save event (for artifacts)
        shell: bash
        run: |
          set -euo pipefail
          cp "$GITHUB_EVENT_PATH" event.json
          jq -r '.' event.json > event.pretty.json || true

      - name: Validate PRIVATE_KEY format (no output of secrets)
        shell: bash
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          set -euo pipefail
          [ -n "${PRIVATE_KEY:-}" ] || { echo "Missing PRIVATE_KEY"; exit 1; }
          printf '%s' "$PRIVATE_KEY" > key.pem
          # ייכשל אם המפתח לא PEM תקין; לא מדפיס את המפתח
          openssl pkey -in key.pem -noout >/dev/null

      - name: Create GitHub App installation token
        id: app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}            # מספר ה-App (לא installation)
          private-key: ${{ secrets.PRIVATE_KEY }}  # PEM רב-שורה של ה-App

      - name: Create branch, add file, open PR (curl only)
        id: pr
        shell: bash
        env:
          GH_TOKEN: ${{ steps.app.outputs.token }}   # טוקן התקנה של ה-App
          API: https://api.github.com
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY}"

          # 1) ענף ברירת מחדל
          BASE=$(
            curl -sS \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$API/repos/$REPO" | jq -r '.default_branch'
          )
          test -n "$BASE" -a "$BASE" != "null"

          # 2) SHA של הבסיס
          BASE_SHA=$(
            curl -sS \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$API/repos/$REPO/git/ref/heads/$BASE" | jq -r '.object.sha'
          )
          test -n "$BASE_SHA" -a "$BASE_SHA" != "null"

          # 3) יצירת ענף חדש (אידמפוטנטי)
          TS=$(date -u +%Y%m%dT%H%M%SZ)
          BR="ops/$TS"
          curl -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API/repos/$REPO/git/refs" \
            -d "{\"ref\":\"refs/heads/$BR\",\"sha\":\"$BASE_SHA\"}" \
            || echo "note: branch may exist already"

          # 4) הוספת קובץ הוכחה
          FILE=".chatops/runs/$TS.txt"
          CONTENT=$(printf "PR proof via App Installation at %s\n" "$TS" | base64 -w 0)
          curl -sS -X PUT \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API/repos/$REPO/contents/$FILE" \
            -d "{\"message\":\"chore(chatops): e2e proof (no-merge)\",\"content\":\"$CONTENT\",\"branch\":\"$BR\"}"

          # 5) פתיחת PR
          RESP=$(
            curl -sS -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$API/repos/$REPO/pulls" \
              -d "{\"title\":\"chatops: e2e proof (no-merge)\",\"head\":\"$BR\",\"base\":\"$BASE\"}"
          )
          URL=$(echo "$RESP" | jq -r '.html_url')
          test -n "$URL" -a "$URL" != "null"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          {
            echo "### ops.edit (PR-only) — result"
            echo "- PR: $URL"
            echo "- run: ${RUN_URL}"
          } >> "$GITHUB_STEP_SUMMARY"
          echo "::notice title=PR Opened::$URL"

      - name: Echo PR URL
        shell: bash
        run: |
          set -euo pipefail
          echo "PR URL=${{ steps.pr.outputs.url }}"

      - name: Upload event artifact (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ops_edit_pr_only_event
          path: |
            event.json
            event.pretty.json
          retention-days: 7
