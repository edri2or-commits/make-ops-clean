name: layer_d_ops_edit

on:
  repository_dispatch:
    types: [ops.edit]

permissions:
  contents: write
  pull-requests: write

jobs:
  edit-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: App token (GitHub App)
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CHATOPS_APP_ID }}
          private-key: ${{ secrets.CHATOPS_APP_PEM }}
          installation-id: ${{ secrets.CHATOPS_INSTALLATION_ID }}

      - name: Ops Edit (branch, file, PR)
        id: ops-edit
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const {owner, repo} = context.repo;
            const p = context.payload.client_payload || {};
            const base = p.base || 'main';
            const branch = p.branch || `chatops/ops-edit-${Date.now()}`;
            const path = p.path;
            const content_b64 = p.content_b64;
            const message = p.commit_message || `ops.edit: ${path}`;
            const pr_title = p.pr_title || `ops.edit: ${path}`;

            if (!path || !content_b64) {
              core.setFailed('Missing required fields: path, content_b64');
              return;
            }

            // get base sha
            const baseRef = await github.rest.git.getRef({ owner, repo, ref: `heads/${base}` });
            const baseSha = baseRef.data.object.sha;

            // create branch (idempotent)
            try {
              await github.rest.git.createRef({ owner, repo, ref: `refs/heads/${branch}`, sha: baseSha });
            } catch (e) {
              if (e.status !== 422) throw e; // already exists â†’ continue
            }

            // create or update file on branch
            let sha;
            try {
              const current = await github.rest.repos.getContent({ owner, repo, path, ref: branch });
              if (Array.isArray(current.data)) { core.setFailed('Path is a directory'); return; }
              sha = current.data.sha;
            } catch (e) {
              if (e.status !== 404) throw e;
            }

            await github.rest.repos.createOrUpdateFileContents({
              owner, repo, path, message, content: content_b64, branch,
              ...(sha ? { sha } : {})
            });

            // open PR (idempotent-ish)
            const prs = await github.rest.pulls.list({ owner, repo, head: `${owner}:${branch}`, state: 'open' });
            let pr;
            if (prs.data.length) {
              pr = prs.data[0];
            } else {
              pr = (await github.rest.pulls.create({ owner, repo, title: pr_title, head: branch, base })).data;
            }

            core.info(`branch=${branch}`);
            core.info(`pr_url=${pr.html_url}`);
            core.setOutput('pr_url', pr.html_url);

      - name: Echo PR URL
        run: echo "PR URL=${{ steps.ops-edit.outputs.pr_url }}"
