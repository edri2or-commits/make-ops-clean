# Workflow to append index and fetch Make blueprints using Workload Identity Federation (OIDC)

name: Append Index and Make Blueprints (OIDC)

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  append_index:
    runs-on: ubuntu-latest
    steps:
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}
          token_format: access_token
          scopes: "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file"

      - name: Append to Index
        run: |
          set -e
          NOW=$(date -Iseconds)
          DATA="{\"values\":[[\"canary\",\"append\",\"CI\",\"$NOW\",\"OK\",\"\"]]}"
          CODE=$(curl -s -o resp.json -w "%{http_code}" -X POST \
            "https://sheets.googleapis.com/v4/spreadsheets/${{ secrets.SHEET_ID }}/values/${{ secrets.TAB }}!A:Z:append?valueInputOption=USER_ENTERED" \
            -H "Authorization: Bearer ${{ steps.auth.outputs.access_token }}" \
            -H "Content-Type: application/json" \
            -d "$DATA")
          echo "HTTP=$CODE"
          cat resp.json
          test "$CODE" = "200"

      - name: Upload response
        uses: actions/upload-artifact@v4
        with:
          name: append-response
          path: resp.json

  make_blueprints:
    if: ${{ secrets.MAKE_API_KEY != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Make Blueprints
        env:
          API_KEY: ${{ secrets.MAKE_API_KEY }}
        run: |
          echo "Pulling blueprints with token present..."
          curl -H "Authorization: Bearer $API_KEY" https://api.make.com/v1/blueprints -o blueprints.json

      - name: Upload blueprints
        uses: actions/upload-artifact@v4
        with:
          name: make-blueprints
          path: blueprints.json
