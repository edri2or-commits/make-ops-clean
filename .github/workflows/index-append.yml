name: Append Index (UTC hourly)

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  run:
    runs-on: ubuntu-latest
    concurrency:
      group: index-append
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER_PATH }}
          service_account: ${{ vars.GCP_SA_EMAIL }}
          token_format: access_token
          access_token_scopes: |
            https://www.googleapis.com/auth/spreadsheets
            https://www.googleapis.com/auth/drive.file
          create_credentials_file: true
          export_environment_variables: true

      - name: Append to Google Sheet
        id: append
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
          SHEET_ID: ${{ vars.SHEET_ID }}
          SHEET_TAB: ${{ vars.SHEET_TAB }}
        run: |
          set -euo pipefail
          printf '{"values":[["auto","%s","%s","%s"]]}\n' "${GITHUB_RUN_ID}" "${GITHUB_SHA}" "$(date -u +%FT%TZ)" > req.json
          code=$(curl -sS -o resp.json -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_TAB}!A1:append?valueInputOption=RAW" \
            --data @req.json)
          echo "HTTP_CODE=${code}" >> "$GITHUB_OUTPUT"
          test "$code" = "200"

      - name: Summarize append result
        run: |
          python3 - <<'PY'
          import json, os
          upd=json.load(open('resp.json')).get('updates',{})
          order=('updatedRange','updatedRows','updatedColumns','updatedCells')
          summary=" ".join(f"{k}={upd.get(k)}" for k in order if upd.get(k) is not None)
          print(summary or "no updates")
          with open(os.environ['GITHUB_STEP_SUMMARY'],'a') as f:
              f.write(summary+"\n")
          PY

      - uses: actions/upload-artifact@v4
        with:
          name: sheet-append-response
          path: resp.json

      - name: Fetch Make Scenario Blueprint (optional)
        if: ${{ always() }}
        env:
          MAKE_TOKEN: ${{ secrets.MAKE_API_TOKEN }}
          MAKE_ZONE:  ${{ vars.MAKE_ZONE }}
          SCENARIO:   ${{ vars.MAKE_SCENARIO_ID }}
        run: |
          set -euo pipefail
          URL="https://${MAKE_ZONE}.make.com/api/v2/scenarios/${SCENARIO}/blueprint"
          echo "::notice title=Make URL::${URL}"
          curl -sS -H "Authorization: Token ${MAKE_TOKEN}" -H "Accept: application/json" "$URL" -o make-blueprint.json || true

      - uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: make-blueprint
          path: make-blueprint.json
          if-no-files-found: ignore
