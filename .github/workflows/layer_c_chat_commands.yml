# Delta:
# 1) Added workflow_dispatch + inputs.text (optional)
# 2) Parser now falls back to .inputs.text (UI run)
# 3) Artifact steps: ensured path: is under with:
# 4) ASCII workflow name to reduce edge cases

name: Layer C Chat Commands (tg)

on:
  repository_dispatch:
    types: [chat.run]
  workflow_dispatch:
    inputs:
      text:
        description: "Chat command (e.g., /make.scenarios)"
        required: false
        type: string

concurrency:
  group: chat-commands
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

env:
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  REPO_FULL: ${{ github.repository }}
  OWNER: ${{ github.repository_owner }}
  EU_BASE: https://eu2.make.com/api/v2
  ORG_ID: "5226765"

jobs:
  route:
    name: Route & Execute Chat Command
    runs-on: ubuntu-latest
    timeout-minutes: 6
    steps:
      - name: Save event payload (for artifacts)
        run: |
          cp "$GITHUB_EVENT_PATH" event.json
          jq -r '.' event.json > event.pretty.json || true

      - name: Parse command from text (repo/dispatch + workflow_dispatch)
        id: parse
        run: |
          TEXT=$(jq -r '.client_payload.message.text // .client_payload.text // .inputs.text // ""' event.json)
          # Fallback from inputs context (only exists on workflow_dispatch)
          FALLBACK="${{ inputs.text }}"
          [ -z "$TEXT" -o "$TEXT" = "null" ] && TEXT="${FALLBACK}"
          TEXT="$(printf '%s' "$TEXT" | tr -s '[:space:]' ' ')"
          CMD="$(printf '%s' "$TEXT" | awk '{print $1}')"
          ARG="$(printf '%s' "$TEXT" | cut -d' ' -f2-)"
          echo "text=$TEXT" >> "$GITHUB_OUTPUT"
          echo "cmd=$CMD"  >> "$GITHUB_OUTPUT"
          echo "arg=$ARG"  >> "$GITHUB_OUTPUT"

      - name: /ping /echo /status
        if: startsWith(steps.parse.outputs.cmd, '/ping') || startsWith(steps.parse.outputs.cmd, '/echo') || startsWith(steps.parse.outputs.cmd, '/status')
        run: |
          cmd="${{ steps.parse.outputs.cmd }}"; arg="${{ steps.parse.outputs.arg }}"
          case "$cmd" in
            /ping)   MSG="pong" ;;
            /echo)   MSG="${arg:-∅}" ;;
            /status) MSG="A/B/C: green · cron:on · sha:${GITHUB_SHA::7}" ;;
            *)       MSG="unknown" ;;
          esac
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MSG" '{chat_id:$chat_id,text:$text}')"

      - name: /gh.run — dispatch workflow
        if: startsWith(steps.parse.outputs.cmd, '/gh.run')
        id: ghrun
        env:
          BOT_PAT: ${{ secrets.BOT_PAT }}
        run: |
          set -euo pipefail
          wf="${{ steps.parse.outputs.arg }}"
          if [ -z "$wf" ] || [ "$wf" = "null" ]; then
            echo "MSG=gh.run ⚠️ missing workflow file" >> "$GITHUB_OUTPUT"; exit 0
          fi
          repo="${{ env.REPO_FULL }}"
          defbranch=$(curl -fsSL -H "Authorization: token ${BOT_PAT}" "https://api.github.com/repos/${repo}" | jq -r '.default_branch')
          code=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: token ${BOT_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${repo}/actions/workflows/${wf}/dispatches" \
            -d "{\"ref\":\"${defbranch}\"}")
          echo "HTTP=$code" >> "$GITHUB_OUTPUT"
          sleep 2
          runs=$(curl -fsSL -H "Authorization: token ${BOT_PAT}" \
            "https://api.github.com/repos/${repo}/actions/workflows/${wf}/runs?event=workflow_dispatch&per_page=1")
          echo "$runs" > gh_runs.json
          run_id=$(jq -r '.workflow_runs[0].id // empty' gh_runs.json)
          html_url=$(jq -r '.workflow_runs[0].html_url // empty' gh_runs.json)
          echo "RUN_ID=$run_id"   >> "$GITHUB_OUTPUT"
          echo "URL=$html_url" >> "$GITHUB_OUTPUT"
          if [ "$code" = "204" ]; then
            echo "MSG=gh.run ✅ 204; run_id=${run_id:-pending}; ${html_url:-n/a}" >> "$GITHUB_OUTPUT"
          else
            echo "MSG=gh.run ⚠️ http=$code" >> "$GITHUB_OUTPUT"
          fi

      - name: Reply /gh.run
        if: startsWith(steps.parse.outputs.cmd, '/gh.run')
        run: |
          MSG="${{ steps.ghrun.outputs.MSG }}"
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MSG" '{chat_id:$chat_id,text:$text}')"

      # ---------- EU2: smoke ----------
      - name: /make.smoke — EU2 GET
        if: startsWith(steps.parse.outputs.cmd, '/make.smoke')
        id: make
        continue-on-error: true
        env:
          MAKE_API_TOKEN: ${{ secrets.MAKE_API_TOKEN }}
        run: |
          url="${EU_BASE}/scenarios?organizationId=${ORG_ID}&limit=1"
          code=$(curl -sS -D headers.txt -o eu2_list.json -w "%{http_code}" \
            -H "Accept: application/json" \
            -H "Authorization: Token ${MAKE_API_TOKEN}" "$url" || echo "000")
          xreq=$(grep -i '^x-request-id:' headers.txt 2>/dev/null | awk '{print $2}' | tr -d '\r')
          echo "HTTP=$code" >> "$GITHUB_OUTPUT" || true
          echo "XREQ=${xreq:-}" >> "$GITHUB_OUTPUT" || true

      - name: Reply /make.smoke
        if: startsWith(steps.parse.outputs.cmd, '/make.smoke')
        run: |
          http="${{ steps.make.outputs.HTTP }}"; xreq="${{ steps.make.outputs.XREQ }}"
          status=$([ "$http" = "200" ] && echo "✅" || echo "⚠️")
          MSG="make.smoke ${status} http=${http:-∅}; x-request-id=${xreq:-∅}"
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MSG" '{chat_id:$chat_id,text:$text}')"

      - name: Upload EU2 smoke artifacts
        if: ${{ always() && hashFiles('headers.txt') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: eu2_smoke_raw
          path: |
            headers.txt
            eu2_list.json

      # ---------- EU2: teams ----------
      - name: /make.teams — list teams
        if: startsWith(steps.parse.outputs.cmd, '/make.teams')
        id: teams
        continue-on-error: true
        env:
          MAKE_API_TOKEN: ${{ secrets.MAKE_API_TOKEN }}
        run: |
          url="${EU_BASE}/teams?organizationId=${ORG_ID}&limit=10"
          curl -sS -D headers_teams.txt -o eu2_teams.json \
            -H "Accept: application/json" \
            -H "Authorization: Token ${MAKE_API_TOKEN}" "$url" || true
          jq -r '.data[]? | "\(.id) — \(.name)"' eu2_teams.json | head -n 6 > teams_top.txt || true

      - name: Reply /make.teams
        if: startsWith(steps.parse.outputs.cmd, '/make.teams')
        run: |
          if [ -s teams_top.txt ]; then
            LINES=$(cat teams_top.txt | sed ':a;N;$!ba;s/\n/\\n/g')
            MSG="make.teams ✅ (top):\n${LINES}"
          else
            MSG="make.teams ⚠️ no teams"
          fi
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MSG" '{chat_id:$chat_id,text:$text}')"

      - name: Upload teams artifacts
        if: ${{ always() && hashFiles('eu2_teams.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: eu2_teams
          path: |
            eu2_teams.json
            headers_teams.txt
            teams_top.txt

      # ---------- EU2: scenarios ----------
      - name: /make.scenarios — list EU2
        if: startsWith(steps.parse.outputs.cmd, '/make.scenarios')
        id: list
        continue-on-error: true
        env:
          MAKE_API_TOKEN: ${{ secrets.MAKE_API_TOKEN }}
        run: |
          url="${EU_BASE}/scenarios?organizationId=${ORG_ID}&limit=10"
          curl -sS -D headers_scenarios.txt -o eu2_scenarios.json \
            -H "Accept: application/json" \
            -H "Authorization: Token ${MAKE_API_TOKEN}" "$url"
          jq -r '.data[]? | "\(.id) — \(.name)"' eu2_scenarios.json | head -n 6 > scenarios_top.txt || true

      - name: Reply /make.scenarios
        if: startsWith(steps.parse.outputs.cmd, '/make.scenarios')
        run: |
          if [ -s scenarios_top.txt ]; then
            LINES=$(cat scenarios_top.txt | sed ':a;N;$!ba;s/\n/\\n/g')
            MSG="make.scenarios ✅ (top):\n${LINES}"
          else
            MSG="make.scenarios ⚠️ no items"
          fi
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MSG" '{chat_id:$chat_id,text:$text}')"

      - name: Upload scenarios artifacts
        if: ${{ always() && hashFiles('eu2_scenarios.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: eu2_scenarios
          path: |
            eu2_scenarios.json
            headers_scenarios.txt
            scenarios_top.txt

      # ---------- EU2: create/start/run ----------
      - name: /make.team.create — create team
        if: startsWith(steps.parse.outputs.cmd, '/make.team.create')
        id: team_create
        env:
          MAKE_API_TOKEN: ${{ secrets.MAKE_API_TOKEN }}
        run: |
          set -euo pipefail
          name="$(printf '%s' "${{ steps.parse.outputs.arg }}" | sed 's/^ *//;s/ *$//')"
          if [ -z "$name" ]; then echo "MSG=make.team.create ⚠️ missing name" >> "$GITHUB_OUTPUT"; exit 0; fi
          url="${EU_BASE}/teams"
          body=$(jq -n --arg name "$name" --argjson orgId $ORG_ID '{name:$name, organizationId:$orgId}')
          printf '%s' "$body" > eu2_team_create_req.json
          curl -sS -D headers_team.txt -o eu2_team_create.json -X POST \
            -H "Accept: application/json" -H "Content-Type: application/json" \
            -H "Authorization: Token ${MAKE_API_TOKEN}" --data "$body" "$url" || true
          code=$(head -n1 headers_team.txt | awk '{print $2}')
          id=$(jq -r '.team.id // empty' eu2_team_create.json)
          if [ "$code" = "200" ] && [ -n "$id" ]; then
            echo "MSG=make.team.create ✅ id=$id" >> "$GITHUB_OUTPUT"
          else
            echo "MSG=make.team.create ⚠️ http=${code:-?}" >> "$GITHUB_OUTPUT"
          fi

      - name: Reply /make.team.create
        if: startsWith(steps.parse.outputs.cmd, '/make.team.create')
        run: |
          MSG="${{ steps.team_create.outputs.MSG }}"
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MSG" '{chat_id:$chat_id,text:$text}')"

      - name: Upload team-create artifacts
        if: ${{ always() && hashFiles('eu2_team_create.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: eu2_team_create
          path: |
            eu2_team_create_req.json
            eu2_team_create.json
            headers_team.txt

      - name: /make.scenario.create — minimal scenario
        if: startsWith(steps.parse.outputs.cmd, '/make.scenario.create')
        id: sc_create
        env:
          MAKE_API_TOKEN: ${{ secrets.MAKE_API_TOKEN }}
        run: |
          set -euo pipefail
          team_id="$(printf '%s' "${{ steps.parse.outputs.arg }}" | awk '{print $1}')"
          if ! printf '%s' "$team_id" | grep -Eq '^[0-9]+$'; then
            echo "MSG=make.scenario.create ⚠️ invalid team id" >> "$GITHUB_OUTPUT"; exit 0
          fi
          url="${EU_BASE}/scenarios"
          blueprint='{"name":"nc2-empty","flow":[{"module":"tools.sleep","parameters":{"milliseconds":1}}]}'
          scheduling='{"type":"indefinitely","interval":900}'
          payload=$(jq -n --arg blueprint "$blueprint" --arg scheduling "$scheduling" --argjson teamId $team_id '{blueprint:$blueprint, scheduling:$scheduling, teamId:$teamId, confirmed:true}')
          printf '%s' "$payload" > eu2_sc_create_req.json
          curl -sS -D headers_sc_create.txt -o eu2_sc_create.json -X POST \
            -H "Accept: application/json" -H "Content-Type: application/json" \
            -H "Authorization: Token ${MAKE_API_TOKEN}" --data "$payload" "$url" || true
          code=$(head -n1 headers_sc_create.txt | awk '{print $2}')
          sid=$(jq -r '.scenario.id // .id // empty' eu2_sc_create.json)
          if [ "$code" = "200" ] && [ -n "$sid" ]; then
            echo "SID=$sid" >> "$GITHUB_OUTPUT"
            echo "MSG=make.scenario.create ✅ id=$sid" >> "$GITHUB_OUTPUT"
          else
            echo "MSG=make.scenario.create ⚠️ http=${code:-?}" >> "$GITHUB_OUTPUT"
          fi

      - name: Reply /make.scenario.create
        if: startsWith(steps.parse.outputs.cmd, '/make.scenario.create')
        run: |
          MSG="${{ steps.sc_create.outputs.MSG }}"
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MSG" '{chat_id:$chat_id,text:$text}')"

      - name: Upload scenario-create artifacts
        if: ${{ always() && hashFiles('eu2_sc_create.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: eu2_sc_create
          path: |
            eu2_sc_create_req.json
            eu2_sc_create.json
            headers_sc_create.txt

      - name: /make.start — activate scenario
        if: startsWith(steps.parse.outputs.cmd, '/make.start')
        id: sc_start
        env:
          MAKE_API_TOKEN: ${{ secrets.MAKE_API_TOKEN }}
        run: |
          sid="$(printf '%s' "${{ steps.parse.outputs.arg }}" | awk '{print $1}')"
          if ! printf '%s' "$sid" | grep -Eq '^[0-9]+$'; then echo "MSG=make.start ⚠️ invalid id" >> "$GITHUB_OUTPUT"; exit 0; fi
          url="${EU_BASE}/scenarios/${sid}/start"
          code=$(curl -sS -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Token ${MAKE_API_TOKEN}" "$url" || echo "000")
          if [ "$code" = "200" ]; then echo "MSG=make.start ✅ id=${sid}" >> "$GITHUB_OUTPUT"; else echo "MSG=make.start ⚠️ http=${code}" >> "$GITHUB_OUTPUT"; fi

      - name: Reply /make.start
        if: startsWith(steps.parse.outputs.cmd, '/make.start')
        run: |
          MSG="${{ steps.sc_start.outputs.MSG }}"
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MSG" '{chat_id:$chat_id,text:$text}')"

      - name: /make.run — run scenario
        if: startsWith(steps.parse.outputs.cmd, '/make.run')
        id: run
        continue-on-error: true
        env:
          MAKE_API_TOKEN: ${{ secrets.MAKE_API_TOKEN }}
        run: |
          set -euo pipefail
          raw="${{ steps.parse.outputs.arg }}"
          scen_id="$(printf '%s' "$raw" | awk '{print $1}')"
          flag="$(printf '%s' "$raw" | awk '{print $2}')"
          wait=false; [ "$flag" = "wait" ] && wait=true
          if ! printf '%s' "$scen_id" | grep -Eq '^[0-9]+$'; then
            printf '%s\n' "make.run ⚠️ missing/invalid id" > run_msg.txt
          else
            body=$(jq -n --argjson responsive "$wait" '{responsive:$responsive}')
            printf '%s' "$body" > eu2_run_req.json
            url="${EU_BASE}/scenarios/${scen_id}/run"
            curl -sS -D headers_run.txt -o eu2_run_resp.json -X POST \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              -H "Authorization: Token ${MAKE_API_TOKEN}" \
              --data "$body" "$url" || true
            execId=$(jq -r '.executionId // empty' eu2_run_resp.json)
            status=$(jq -r '.status // empty' eu2_run_resp.json)
            if [ -n "$execId" ]; then
              printf '%s\n' "make.run ✅ id=${scen_id}; executionId=${execId}; status=${status:-n/a}" > run_msg.txt
            else
              code=$(head -n1 headers_run.txt | awk '{print $2}')
              printf '%s\n' "make.run ⚠️ id=${scen_id}; http=${code:-?}" > run_msg.txt
            fi
          fi

      - name: Reply /make.run
        if: startsWith(steps.parse.outputs.cmd, '/make.run')
        run: |
          MSG="$(cat run_msg.txt 2>/dev/null || echo 'make.run ⚠️ internal')"
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MSG" '{chat_id:$chat_id,text:$text}')"

      - name: Upload run artifacts
        if: ${{ always() && hashFiles('eu2_run_resp.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: eu2_run
          path: |
            eu2_run_req.json
            eu2_run_resp.json
            headers_run.txt

      - name: Upload chat event (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: chat_event
          path: |
            event.json
            event.pretty.json
