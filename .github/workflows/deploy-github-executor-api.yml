name: Deploy GitHub Executor API to Cloud Run

on:
  workflow_dispatch:

env:
  PROJECT_ID: edri2or-mcp
  SERVICE_NAME: github-executor-api
  REGION: us-central1
  SOURCE_DIR: cloud-run/google-workspace-github-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/211420842852/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
          service_account: 'github-actions-sa@edri2or-mcp.iam.gserviceaccount.com'
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Verify Secret Exists
        id: check-secret
        run: |
          if gcloud secrets describe github-executor-api-token --project=$PROJECT_ID 2>/dev/null; then
            echo "âœ… Secret 'github-executor-api-token' exists"
            echo "secret_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Secret 'github-executor-api-token' not found"
            echo "secret_exists=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸  BLOCKER: GitHub PAT secret is missing!"
            echo "Please create the secret first using:"
            echo "  gcloud secrets create github-executor-api-token \\"
            echo "    --data-file=- --project=$PROJECT_ID"
            exit 1
          fi
      
      - name: Deploy to Cloud Run
        if: steps.check-secret.outputs.secret_exists == 'true'
        run: |
          cd $SOURCE_DIR
          
          echo "ðŸ“¦ Deploying GitHub Executor API..."
          gcloud run deploy $SERVICE_NAME \
            --source . \
            --platform managed \
            --region $REGION \
            --project $PROJECT_ID \
            --allow-unauthenticated \
            --set-env-vars="GITHUB_OWNER=edri2or-commits,GITHUB_REPO=make-ops-clean" \
            --set-secrets="GITHUB_TOKEN=github-executor-api-token:latest" \
            --memory=512Mi \
            --cpu=1 \
            --timeout=60s \
            --min-instances=0 \
            --max-instances=10
          
          echo "âœ… Deployment complete!"
      
      - name: Get Service URL
        id: get-url
        if: steps.check-secret.outputs.secret_exists == 'true'
        run: |
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME \
            --platform managed \
            --region $REGION \
            --project $PROJECT_ID \
            --format='value(status.url)')
          
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "ðŸŒ Service URL: $SERVICE_URL"
      
      - name: Test Health Endpoint
        if: steps.check-secret.outputs.secret_exists == 'true'
        run: |
          SERVICE_URL="${{ steps.get-url.outputs.service_url }}"
          echo "Testing health endpoint..."
          
          RESPONSE=$(curl -s "$SERVICE_URL/")
          echo "Response: $RESPONSE"
          
          if echo "$RESPONSE" | grep -q "GitHub Executor API"; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed!"
            exit 1
          fi
      
      - name: Create Deployment Evidence
        if: steps.check-secret.outputs.secret_exists == 'true'
        run: |
          mkdir -p evidence
          cat > evidence/github-executor-deployment.json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "action": "deploy_github_executor_api",
            "service_name": "$SERVICE_NAME",
            "region": "$REGION",
            "project": "$PROJECT_ID",
            "service_url": "${{ steps.get-url.outputs.service_url }}",
            "status": "success",
            "workflow_run": "${{ github.run_id }}",
            "workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          cat evidence/github-executor-deployment.json
      
      - name: Upload Evidence
        if: steps.check-secret.outputs.secret_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: github-executor-deployment-evidence
          path: evidence/
          retention-days: 90
      
      - name: Summary
        if: steps.check-secret.outputs.secret_exists == 'true'
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: $SERVICE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: $REGION" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.get-url.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Test Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Health check" >> $GITHUB_STEP_SUMMARY
          echo "curl ${{ steps.get-url.outputs.service_url }}/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Read file" >> $GITHUB_STEP_SUMMARY
          echo 'curl "${{ steps.get-url.outputs.service_url }}/repo/read-file?path=README.md"' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
