name: control-dispatch
on:
  schedule:
    - cron: "*/5 * * * *"  # Restored: every 5 minutes
  repository_dispatch:
    types: [eval_dod]
  workflow_dispatch:
    inputs:
      target_ref:
        description: "Branch to test"
        default: "feature/pr-9-workspace-smoke"
        required: true

permissions:
  id-token: write
  contents: write

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout for lock
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Check lock
        id: check_lock
        run: |
          mkdir -p .control/locks
          if ls .control/locks/dispatch-*.lock 1> /dev/null 2>&1; then
            echo "ðŸ”’ Dispatch lock exists - skipping"
            echo "locked=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No lock - proceeding"
            echo "locked=false" >> $GITHUB_OUTPUT
          fi

      - name: Try GitHub App Token
        if: steps.check_lock.outputs.locked != 'true'
        id: app_token
        continue-on-error: true
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.GH_APP_ID || '' }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY_PEM || '' }}
          owner: edri2or-commits
          repositories: make-ops-clean

      - name: Dispatch eval-dod
        if: steps.check_lock.outputs.locked != 'true'
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token || secrets.PAT_AUTOMATION || secrets.GITHUB_TOKEN }}
        run: |
          REF="${{ inputs.target_ref || github.event.client_payload.target_ref || 'feature/pr-9-workspace-smoke' }}"
          echo "ðŸŽ¯ Dispatching eval-dod.yml on ref: $REF"
          
          # Determine token source for logging
          if [ -n "${{ steps.app_token.outputs.token }}" ]; then
            echo "ðŸ”‘ Using: GitHub App token"
          elif [ -n "${{ secrets.PAT_AUTOMATION }}" ]; then
            echo "ðŸ”‘ Using: PAT_AUTOMATION"
          else
            echo "âš ï¸  Using: GITHUB_TOKEN (limited dispatch capability)"
          fi
          
          curl -sf -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/edri2or-commits/make-ops-clean/actions/workflows/eval-dod.yml/dispatches \
            -d "{\"ref\":\"$REF\",\"inputs\":{\"target_ref\":\"$REF\"}}" \
            && echo "âœ… Dispatch successful" \
            || echo "âŒ Dispatch failed - check token permissions"

      - name: Create dispatch lock
        if: steps.check_lock.outputs.locked != 'true'
        run: |
          TS=$(date +%s)
          mkdir -p .control/locks
          touch ".control/locks/dispatch-$TS.lock"
          echo "Dispatched at: $(date -u)" > ".control/locks/dispatch-$TS.lock"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .control/locks/
          git commit -m "chore(control): create dispatch lock [auto-revert pending]"
          git push
