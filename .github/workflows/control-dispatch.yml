name: control-dispatch
on:
  schedule:
    - cron: "* * * * *"  # Accelerated: every minute (temporary)
  repository_dispatch:
    types: [eval_dod]
  workflow_dispatch:
    inputs:
      target_ref:
        description: "Branch to test"
        default: "feature/pr-9-workspace-smoke"
        required: true

permissions:
  id-token: write
  contents: write

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout for lock
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Check lock
        id: check_lock
        run: |
          mkdir -p .control/locks
          if ls .control/locks/dispatch-*.lock 1> /dev/null 2>&1; then
            echo "ðŸ”’ Dispatch lock exists - skipping"
            echo "locked=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No lock - proceeding"
            echo "locked=false" >> $GITHUB_OUTPUT
          fi

      - name: Send repository_dispatch to eval-dod
        if: steps.check_lock.outputs.locked != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REF="${{ inputs.target_ref || github.event.client_payload.target_ref || 'feature/pr-9-workspace-smoke' }}"
          echo "ðŸŽ¯ Sending repository_dispatch to eval-dod"
          echo "   Type: run_dod"
          echo "   Target: $REF"
          
          curl -sf -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/edri2or-commits/make-ops-clean/dispatches \
            -d "{\"event_type\":\"run_dod\",\"client_payload\":{\"target_ref\":\"$REF\"}}" \
            && echo "âœ… Repository dispatch sent successfully" \
            || echo "âŒ Dispatch failed - check permissions"

      - name: Create dispatch lock
        if: steps.check_lock.outputs.locked != 'true'
        run: |
          TS=$(date +%s)
          mkdir -p .control/locks
          touch ".control/locks/dispatch-$TS.lock"
          echo "Dispatched at: $(date -u)" > ".control/locks/dispatch-$TS.lock"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .control/locks/
          git commit -m "chore(control): create dispatch lock [auto-revert pending]"
          git push
