name: Secret Manager Operations

on:
  workflow_call:
    inputs:
      action:
        description: 'Action to perform (read, create, update, create_or_update)'
        required: true
        type: string
      secret_id:
        description: 'Secret ID (name)'
        required: true
        type: string
      secret_value:
        description: 'Secret value (for create/update operations)'
        required: false
        type: string
      project_id:
        description: 'GCP Project ID'
        required: false
        type: string
        default: 'edri2or-mcp'
    outputs:
      status:
        description: 'Operation status (success/failure)'
        value: ${{ jobs.execute.outputs.status }}
      secret_value:
        description: 'Secret value (for read operations, redacted in logs)'
        value: ${{ jobs.execute.outputs.secret_value }}
      error:
        description: 'Error message if operation failed'
        value: ${{ jobs.execute.outputs.error }}

permissions:
  contents: write
  id-token: write

jobs:
  execute:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      status: ${{ steps.operation.outputs.status }}
      secret_value: ${{ steps.operation.outputs.secret_value }}
      error: ${{ steps.operation.outputs.error }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to GCP via WIF
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER_PATH }}
          service_account: ${{ vars.GCP_SA_EMAIL }}
          token_format: access_token
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ inputs.project_id }}

      - name: Validate inputs
        id: validate
        run: |
          ACTION="${{ inputs.action }}"
          SECRET_ID="${{ inputs.secret_id }}"
          
          echo "=== Validating Inputs ==="
          echo "Action: $ACTION"
          echo "Secret ID: $SECRET_ID"
          echo "Project: ${{ inputs.project_id }}"
          
          # Validate action
          case "$ACTION" in
            read|create|update|create_or_update)
              echo "✅ Valid action: $ACTION"
              ;;
            *)
              echo "❌ Invalid action: $ACTION"
              echo "Must be one of: read, create, update, create_or_update"
              exit 1
              ;;
          esac
          
          # Validate secret_id format (alphanumeric, hyphens, underscores only)
          if ! echo "$SECRET_ID" | grep -qE '^[a-zA-Z0-9_-]+$'; then
            echo "❌ Invalid secret_id format: $SECRET_ID"
            echo "Must contain only letters, numbers, hyphens, and underscores"
            exit 1
          fi
          
          # For create/update operations, require secret_value
          if [[ "$ACTION" == "create" || "$ACTION" == "update" || "$ACTION" == "create_or_update" ]]; then
            if [[ -z "${{ inputs.secret_value }}" ]]; then
              echo "❌ secret_value is required for action: $ACTION"
              exit 1
            fi
          fi
          
          echo "✅ Validation passed"

      - name: Execute Secret Manager operation
        id: operation
        run: |
          set +e  # Don't exit on error, we want to capture it
          
          ACTION="${{ inputs.action }}"
          SECRET_ID="${{ inputs.secret_id }}"
          SECRET_VALUE="${{ inputs.secret_value }}"
          PROJECT_ID="${{ inputs.project_id }}"
          
          echo "=== Executing Secret Manager Operation ==="
          echo "Action: $ACTION"
          echo "Secret ID: $SECRET_ID"
          echo "Project: $PROJECT_ID"
          
          # Initialize outputs
          STATUS="failure"
          ERROR=""
          SECRET_VALUE_OUTPUT=""
          
          case "$ACTION" in
            read)
              echo "→ Reading secret: $SECRET_ID"
              
              # Attempt to read secret
              OUTPUT=$(gcloud secrets versions access latest \
                --secret="$SECRET_ID" \
                --project="$PROJECT_ID" 2>&1)
              EXIT_CODE=$?
              
              if [ $EXIT_CODE -eq 0 ]; then
                echo "✅ Secret read successfully"
                STATUS="success"
                SECRET_VALUE_OUTPUT="$OUTPUT"
                # Don't log the actual value
                echo "Secret value retrieved (length: ${#OUTPUT} chars)"
              else
                echo "❌ Failed to read secret"
                ERROR="$OUTPUT"
                echo "Error: $ERROR"
              fi
              ;;
              
            create)
              echo "→ Creating new secret: $SECRET_ID"
              
              # Check if secret already exists
              if gcloud secrets describe "$SECRET_ID" --project="$PROJECT_ID" &>/dev/null; then
                echo "❌ Secret already exists: $SECRET_ID"
                ERROR="Secret already exists. Use 'update' or 'create_or_update' action instead."
                STATUS="failure"
              else
                # Create secret
                if echo -n "$SECRET_VALUE" | gcloud secrets create "$SECRET_ID" \
                  --data-file=- \
                  --project="$PROJECT_ID" 2>&1; then
                  echo "✅ Secret created successfully"
                  STATUS="success"
                else
                  echo "❌ Failed to create secret"
                  ERROR="Failed to create secret $SECRET_ID"
                  STATUS="failure"
                fi
              fi
              ;;
              
            update)
              echo "→ Updating existing secret: $SECRET_ID"
              
              # Check if secret exists
              if ! gcloud secrets describe "$SECRET_ID" --project="$PROJECT_ID" &>/dev/null; then
                echo "❌ Secret does not exist: $SECRET_ID"
                ERROR="Secret does not exist. Use 'create' or 'create_or_update' action instead."
                STATUS="failure"
              else
                # Add new version
                if echo -n "$SECRET_VALUE" | gcloud secrets versions add "$SECRET_ID" \
                  --data-file=- \
                  --project="$PROJECT_ID" 2>&1; then
                  echo "✅ Secret updated successfully (new version added)"
                  STATUS="success"
                else
                  echo "❌ Failed to update secret"
                  ERROR="Failed to add new version to secret $SECRET_ID"
                  STATUS="failure"
                fi
              fi
              ;;
              
            create_or_update)
              echo "→ Creating or updating secret: $SECRET_ID"
              
              # Check if secret exists
              if gcloud secrets describe "$SECRET_ID" --project="$PROJECT_ID" &>/dev/null; then
                echo "Secret exists, adding new version..."
                if echo -n "$SECRET_VALUE" | gcloud secrets versions add "$SECRET_ID" \
                  --data-file=- \
                  --project="$PROJECT_ID" 2>&1; then
                  echo "✅ Secret updated successfully (new version added)"
                  STATUS="success"
                else
                  echo "❌ Failed to update secret"
                  ERROR="Failed to add new version to secret $SECRET_ID"
                  STATUS="failure"
                fi
              else
                echo "Secret does not exist, creating..."
                if echo -n "$SECRET_VALUE" | gcloud secrets create "$SECRET_ID" \
                  --data-file=- \
                  --project="$PROJECT_ID" 2>&1; then
                  echo "✅ Secret created successfully"
                  STATUS="success"
                else
                  echo "❌ Failed to create secret"
                  ERROR="Failed to create secret $SECRET_ID"
                  STATUS="failure"
                fi
              fi
              ;;
          esac
          
          # Set outputs (careful with secrets!)
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          
          # Only output secret value for read operations, and mark as secret
          if [[ "$ACTION" == "read" && "$STATUS" == "success" ]]; then
            echo "::add-mask::$SECRET_VALUE_OUTPUT"
            echo "secret_value=$SECRET_VALUE_OUTPUT" >> "$GITHUB_OUTPUT"
          else
            echo "secret_value=" >> "$GITHUB_OUTPUT"
          fi
          
          if [[ -n "$ERROR" ]]; then
            echo "error=$ERROR" >> "$GITHUB_OUTPUT"
          else
            echo "error=" >> "$GITHUB_OUTPUT"
          fi
          
          # Exit with appropriate code
          if [[ "$STATUS" == "success" ]]; then
            exit 0
          else
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          STATUS="${{ steps.operation.outputs.status }}"
          ERROR="${{ steps.operation.outputs.error }}"
          
          cat >> "$GITHUB_STEP_SUMMARY" <<SUMMARY
          ## Secret Manager Operation Summary
          
          **Action**: \`${{ inputs.action }}\`  
          **Secret ID**: \`${{ inputs.secret_id }}\`  
          **Project**: \`${{ inputs.project_id }}\`  
          **Status**: \`$STATUS\`
          
          $(if [ "$STATUS" = "failure" ]; then
            echo "**Error**: $ERROR"
          else
            echo "✅ Operation completed successfully"
          fi)
          SUMMARY
