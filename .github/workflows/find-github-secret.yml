name: Find GitHub Secret (Auto-trigger)

on:
  push:
    paths:
      - 'DOCS/.trigger_secret_search'
  workflow_dispatch:

jobs:
  find-secret:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER_PATH }}
          service_account: ${{ vars.GCP_SA_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: List ALL secrets in Secret Manager
        id: list_secrets
        run: |
          echo "=== Listing all secrets in edri2or-mcp ==="
          gcloud secrets list --project=edri2or-mcp --format="table(name,createTime)" | tee secrets_list.txt
          
          echo ""
          echo "=== Searching for GitHub-related secrets ==="
          gcloud secrets list --project=edri2or-mcp --format="json" | jq -r '.[] | select(.name | test("github|token|pat|executor"; "i")) | .name' | tee github_secrets.txt || echo "No GitHub-related secrets found by name"
          
          echo ""
          echo "=== Checking secret metadata for GitHub hints ==="
          for secret in $(gcloud secrets list --project=edri2or-mcp --format="value(name)"); do
            echo "Checking: $secret"
            gcloud secrets describe "$secret" --project=edri2or-mcp --format="json" | jq -r '. | "Name: \(.name), Created: \(.createTime), Labels: \(.labels // {})"' 2>/dev/null || true
          done | tee secret_metadata.txt

      - name: Save results
        run: |
          mkdir -p DOCS/secret_search_results
          cp secrets_list.txt DOCS/secret_search_results/ 2>/dev/null || true
          cp github_secrets.txt DOCS/secret_search_results/ 2>/dev/null || true
          cp secret_metadata.txt DOCS/secret_search_results/ 2>/dev/null || true
          
          echo "# Secret Search Results" > DOCS/secret_search_results/SUMMARY.md
          echo "" >> DOCS/secret_search_results/SUMMARY.md
          echo "**Date**: $(date -u +%Y-%m-%d)" >> DOCS/secret_search_results/SUMMARY.md
          echo "**Project**: edri2or-mcp" >> DOCS/secret_search_results/SUMMARY.md
          echo "" >> DOCS/secret_search_results/SUMMARY.md
          echo "## All Secrets Found" >> DOCS/secret_search_results/SUMMARY.md
          echo '```' >> DOCS/secret_search_results/SUMMARY.md
          cat secrets_list.txt >> DOCS/secret_search_results/SUMMARY.md
          echo '```' >> DOCS/secret_search_results/SUMMARY.md
          echo "" >> DOCS/secret_search_results/SUMMARY.md
          echo "## GitHub-Related Secrets" >> DOCS/secret_search_results/SUMMARY.md
          echo '```' >> DOCS/secret_search_results/SUMMARY.md
          cat github_secrets.txt >> DOCS/secret_search_results/SUMMARY.md 2>/dev/null || echo "None found by name pattern"
          echo '```' >> DOCS/secret_search_results/SUMMARY.md

      - name: Commit results
        run: |
          git config user.name "Claude Bot"
          git config user.email "edri2or@gmail.com"
          git add DOCS/secret_search_results/
          git commit -m "search: secret manager scan results" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: Upload as artifact
        uses: actions/upload-artifact@v4
        with:
          name: secret-search-results
          path: DOCS/secret_search_results/
          retention-days: 1
