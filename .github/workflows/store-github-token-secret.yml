name: Store GitHub Token in Secret Manager

on:
  workflow_dispatch:
    inputs:
      github_token:
        description: 'GitHub Personal Access Token (will be stored securely)'
        required: true
        type: string

jobs:
  store-secret:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/211420842852/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
          service_account: 'github-actions-sa@edri2or-mcp.iam.gserviceaccount.com'
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Store GitHub Token in Secret Manager
        run: |
          echo "Storing GitHub PAT in Secret Manager..."
          
          # Check if secret exists
          if gcloud secrets describe github-executor-api-token --project=edri2or-mcp 2>/dev/null; then
            echo "Secret exists, adding new version..."
            echo -n "${{ inputs.github_token }}" | gcloud secrets versions add github-executor-api-token \
              --data-file=- \
              --project=edri2or-mcp
          else
            echo "Creating new secret..."
            echo -n "${{ inputs.github_token }}" | gcloud secrets create github-executor-api-token \
              --data-file=- \
              --replication-policy="automatic" \
              --project=edri2or-mcp
          fi
          
          echo "✅ GitHub token stored successfully!"
          
      - name: Verify secret
        run: |
          echo "Verifying secret exists..."
          gcloud secrets describe github-executor-api-token --project=edri2or-mcp
          echo "✅ Secret verified!"
      
      - name: Create evidence file
        run: |
          mkdir -p evidence
          cat > evidence/github-token-stored.json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "action": "store_github_token",
            "secret_name": "github-executor-api-token",
            "project": "edri2or-mcp",
            "status": "success",
            "workflow_run": "${{ github.run_id }}",
            "workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          cat evidence/github-token-stored.json
      
      - name: Upload evidence
        uses: actions/upload-artifact@v4
        with:
          name: github-token-storage-evidence
          path: evidence/
          retention-days: 90
