name: Get MCP Worker URL

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  get-url:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Get Cloudflare subdomain and construct URL
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          set -euo pipefail
          
          # Get subdomain
          SUBDOMAIN=$(curl -sS -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/workers/subdomain" \
            | jq -r '.result.subdomain')
          
          # Worker name from wrangler.toml
          WORKER_NAME="make-ops-clean-mcp"
          
          # Construct URL
          WORKER_URL="https://${WORKER_NAME}.${SUBDOMAIN}.workers.dev"
          
          echo "WORKER_URL=${WORKER_URL}"
          echo "WORKER_URL=${WORKER_URL}" >> $GITHUB_ENV
          
          # Save to file
          mkdir -p ops/diag
          cat > ops/diag/WORKER_URL.txt <<EOF
          ${WORKER_URL}
          EOF
      
      - name: Test worker health
        run: |
          echo "Testing worker at: ${WORKER_URL}"
          
          # Test /sse endpoint
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${WORKER_URL}/sse" || echo "FAILED")
          echo "SSE endpoint status: ${STATUS}"
          
          # Test if worker responds
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "101" ]; then
            echo "✅ Worker is healthy"
          else
            echo "⚠️  Worker status code: ${STATUS}"
          fi
          
          # Save test results
          cat > ops/diag/WORKER_HEALTH.txt <<EOF
          Test Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          Worker URL: ${WORKER_URL}
          SSE Status: ${STATUS}
          EOF
      
      - name: Commit worker info
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add ops/diag/WORKER_URL.txt ops/diag/WORKER_HEALTH.txt
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "auto: Update MCP worker URL and health status"
            git push
          fi
      
      - name: Create artifact
        uses: actions/upload-artifact@v4
        with:
          name: mcp-worker-info
          path: |
            ops/diag/WORKER_URL.txt
            ops/diag/WORKER_HEALTH.txt
